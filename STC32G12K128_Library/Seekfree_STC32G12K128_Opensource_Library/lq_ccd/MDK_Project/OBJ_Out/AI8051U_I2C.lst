C251 COMPILER V5.60.0,  AI8051U_I2C                                                        18/11/25  13:45:58  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE AI8051U_I2C
OBJECT MODULE PLACED IN .\OBJ_Out\AI8051U_I2C.obj
COMPILER INVOKED BY: D:\MDK\C251\BIN\C251.EXE ..\..\libraries\Driver\Src\AI8051U_I2C.c XSMALL UNSIGNED_CHAR FLOAT64 BROW
                    -SE INCDIR(..\..\libraries\Driver;..\..\libraries\Include;..\..\libraries\Driver\Inc;..\..\libraries\LQ_LIB\Inc;..\User) 
                    -DEFINE(AI8051U_32Bit) DEBUG PRINT(.\OBJ_Out\AI8051U_I2C.lst) OBJECT(.\OBJ_Out\AI8051U_I2C.obj) 

stmt  level    source

    1          /*---------------------------------------------------------------------*/
    2          /* ------------------- Web: www.STCAI.com -----------------------------*/
    3          /*---------------------------------------------------------------------*/
    4          
    5          #include "AI8051U_I2C.h"
    6          
    7          u8 I2C_BUF_type I2C_Buffer[I2C_BUF_LENTH];
    8          
    9          #define SLAW 0xA2
   10          #define SLAR 0xA3
   11          
   12          //========================================================================
   13          // 函数: void I2C_Init(I2C_InitTypeDef *I2Cx)
   14          // 描述: I2C初始化程序.
   15          // 参数: I2Cx: 结构参数,请参考I2C.h里的定义.
   16          // 返回: none.
   17          // 版本: V1.0, 2012-11-22
   18          //========================================================================
   19          void I2C_Init(I2C_InitTypeDef *I2Cx)
   20          {
   21   1              if (I2Cx->I2C_Mode == I2C_Mode_Master)
   22   1              {
   23   2                      I2C_Master();   // 设为主机
   24   2                      I2CMSST = 0x00; // 清除I2C主机状态寄存器
   25   2                      I2C_SetSpeed(I2Cx->I2C_Speed);
   26   2                      if (I2Cx->I2C_MS_WDTA == ENABLE)
   27   2                              I2C_WDTA_EN(); // 使能自动发送
   28   2                      else
   29   2                              I2C_WDTA_DIS(); // 禁止自动发送
   30   2              }
   31   1              else
   32   1              {
   33   2                      I2C_Slave();    // 设为从机
   34   2                      I2CSLST = 0x00; // 清除I2C从机状态寄存器
   35   2                      I2C_Address(I2Cx->I2C_SL_ADR);
   36   2                      if (I2Cx->I2C_SL_MA == ENABLE)
   37   2                              I2C_MATCH_EN(); // 从机地址比较功能，只接受相匹配地址
   38   2                      else
   39   2                              I2C_MATCH_DIS(); // 禁止从机地址比较功能，接受所有设备地址
   40   2              }
   41   1      
   42   1              I2C_Function(I2Cx->I2C_Enable);
   43   1      }
   44          
   45          //========================================================================
   46          // 函数: u8     Get_MSBusy_Status (void)
   47          // 描述: 获取主机忙碌状态.
   48          // 参数: none.
   49          // 返回: 主机忙碌状态.
   50          // 版本: V1.0, 2012-11-22
   51          //========================================================================
   52          u8 Get_MSBusy_Status(void)
   53          {
   54   1              return (I2CMSST & 0x80);
   55   1      }
   56          
   57          //========================================================================
C251 COMPILER V5.60.0,  AI8051U_I2C                                                        18/11/25  13:45:58  PAGE 2   

   58          // 函数: void   Wait (void)
   59          // 描述: 等待主机模式I2C控制器执行完成I2CMSCR.
   60          // 参数: none.
   61          // 返回: none.
   62          // 版本: V1.0, 2012-11-22
   63          //========================================================================
   64          void Wait()
   65          {
   66   1              while (!(I2CMSST & 0x40))
   67   1                      ;
   68   1              I2CMSST &= ~0x40;
   69   1      }
   70          
   71          //========================================================================
   72          // 函数: void Start (void)
   73          // 描述: I2C总线起始函数.
   74          // 参数: none.
   75          // 返回: none.
   76          // 版本: V1.0, 2020-09-15
   77          //========================================================================
   78          void Start()
   79          {
   80   1              I2CMSCR = 0x01; // 发送START命令
   81   1              Wait();
   82   1      }
   83          
   84          //========================================================================
   85          // 函数: void SendData (char dat)
   86          // 描述: I2C发送一个字节数据函数.
   87          // 参数: 发送的数据.
   88          // 返回: none.
   89          // 版本: V1.0, 2020-09-15
   90          //========================================================================
   91          void SendData(char dat)
   92          {
   93   1              I2CTXD = dat;   // 写数据到数据缓冲区
   94   1              I2CMSCR = 0x02; // 发送SEND命令
   95   1              Wait();
   96   1      }
   97          
   98          //========================================================================
   99          // 函数: void RecvACK (void)
  100          // 描述: I2C获取ACK函数.
  101          // 参数: none.
  102          // 返回: none.
  103          // 版本: V1.0, 2020-09-15
  104          //========================================================================
  105          void RecvACK()
  106          {
  107   1              I2CMSCR = 0x03; // 发送读ACK命令
  108   1              Wait();
  109   1      }
  110          
  111          //========================================================================
  112          // 函数: char RecvData (void)
  113          // 描述: I2C读取一个字节数据函数.
  114          // 参数: none.
  115          // 返回: 读取数据.
  116          // 版本: V1.0, 2020-09-15
  117          //========================================================================
  118          char RecvData()
  119          {
  120   1              I2CMSCR = 0x04; // 发送RECV命令
  121   1              Wait();
  122   1              return I2CRXD;
  123   1      }
C251 COMPILER V5.60.0,  AI8051U_I2C                                                        18/11/25  13:45:58  PAGE 3   

  124          
  125          //========================================================================
  126          // 函数: void SendACK (void)
  127          // 描述: I2C发送ACK函数.
  128          // 参数: none.
  129          // 返回: none.
  130          // 版本: V1.0, 2020-09-15
  131          //========================================================================
  132          void SendACK()
  133          {
  134   1              I2CMSST = 0x00; // 设置ACK信号
  135   1              I2CMSCR = 0x05; // 发送ACK命令
  136   1              Wait();
  137   1      }
  138          
  139          //========================================================================
  140          // 函数: void SendNAK (void)
  141          // 描述: I2C发送NAK函数.
  142          // 参数: none.
  143          // 返回: none.
  144          // 版本: V1.0, 2020-09-15
  145          //========================================================================
  146          void SendNAK()
  147          {
  148   1              I2CMSST = 0x01; // 设置NAK信号
  149   1              I2CMSCR = 0x05; // 发送ACK命令
  150   1              Wait();
  151   1      }
  152          
  153          //========================================================================
  154          // 函数: void Stop (void)
  155          // 描述: I2C总线停止函数.
  156          // 参数: none.
  157          // 返回: none.
  158          // 版本: V1.0, 2020-09-15
  159          //========================================================================
  160          void Stop()
  161          {
  162   1              I2CMSCR = 0x06; // 发送STOP命令
  163   1              Wait();
  164   1      }
  165          
  166          //========================================================================
  167          // 函数: void SendCmdData (u8 cmd, u8 dat)
  168          // 描述: I2C发送一个字节数据函数.
  169          // 参数: 命令/数据.
  170          // 返回: none.
  171          // 版本: V1.0, 2020-09-15
  172          //========================================================================
  173          void SendCmdData(u8 cmd, u8 dat)
  174          {
  175   1              I2CTXD = dat;  // 写数据到数据缓冲区
  176   1              I2CMSCR = cmd; // 设置命令
  177   1              Wait();
  178   1      }
  179          
  180          //========================================================================
  181          // 函数: void I2C_WriteNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)
  182          // 描述: I2C写入数据函数.
  183          // 参数: dev_addr: 设备地址, mem_addr: 存储地址, *p写入数据存储位置, number写入数据个数.
  184          // 返回: none.
  185          // 版本: V1.0, 2020-09-15
  186          //========================================================================
  187          void I2C_WriteNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number) /*  DeviceAddress,WordAddress,First Data 
             -Address,Byte lenth   */
  188          {
C251 COMPILER V5.60.0,  AI8051U_I2C                                                        18/11/25  13:45:58  PAGE 4   

  189   1              Start();                        // 发送起始命令
  190   1              SendData(dev_addr); // 发送设备地址+写命令
  191   1              RecvACK();
  192   1              SendData(mem_addr); // 发送存储地址
  193   1              RecvACK();
  194   1              do
  195   1              {
  196   2                      SendData(*p++);
  197   2                      RecvACK();
  198   2              } while (--number);
  199   1              Stop(); // 发送停止命令
  200   1      }
  201          
  202          //========================================================================
  203          // 函数: void I2C_ReadNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number)
  204          // 描述: I2C读取数据函数.
  205          // 参数: dev_addr: 设备地址, mem_addr: 存储地址, *p读取数据存储位置, number读取数据个数.
  206          // 返回: none.
  207          // 版本: V1.0, 2020-09-15
  208          //========================================================================
  209          void I2C_ReadNbyte(u8 dev_addr, u8 mem_addr, u8 *p, u8 number) /*  DeviceAddress,WordAddress,First Data A
             -ddress,Byte lenth   */
  210          {
  211   1              Start();                        // 发送起始命令
  212   1              SendData(dev_addr); // 发送设备地址+写命令
  213   1              RecvACK();
  214   1              SendData(mem_addr); // 发送存储地址
  215   1              RecvACK();
  216   1              Start();                                // 发送起始命令
  217   1              SendData(dev_addr | 1); // 发送设备地址+读命令
  218   1              RecvACK();
  219   1              do
  220   1              {
  221   2                      *p = RecvData();
  222   2                      p++;
  223   2                      if (number != 1)
  224   2                              SendACK(); // send ACK
  225   2              } while (--number);
  226   1              SendNAK(); // send no ACK
  227   1              Stop();    // 发送停止命令
  228   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       555     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =         8          6
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
