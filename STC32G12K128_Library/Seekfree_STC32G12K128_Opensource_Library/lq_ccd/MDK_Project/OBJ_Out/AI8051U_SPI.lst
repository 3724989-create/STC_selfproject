C251 COMPILER V5.60.0,  AI8051U_SPI                                                        18/11/25  13:45:59  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE AI8051U_SPI
OBJECT MODULE PLACED IN .\OBJ_Out\AI8051U_SPI.obj
COMPILER INVOKED BY: D:\MDK\C251\BIN\C251.EXE ..\..\libraries\Driver\Src\AI8051U_SPI.c XSMALL UNSIGNED_CHAR FLOAT64 BROW
                    -SE INCDIR(..\..\libraries\Driver;..\..\libraries\Include;..\..\libraries\Driver\Inc;..\..\libraries\LQ_LIB\Inc;..\User) 
                    -DEFINE(AI8051U_32Bit) DEBUG PRINT(.\OBJ_Out\AI8051U_SPI.lst) OBJECT(.\OBJ_Out\AI8051U_SPI.obj) 

stmt  level    source

    1          /*---------------------------------------------------------------------*/
    2          /* ------------------- Web: www.STCAI.com -----------------------------*/
    3          /*---------------------------------------------------------------------*/
    4          
    5          #include "AI8051U_SPI.h"
    6          #include "AI8051U_Delay.h"
    7          u8      SPI_RxTimerOut;
    8          u8 SPI_Wait_time_out=0;
    9          u8      SPI_BUF_type SPI_RxBuffer[SPI_BUF_LENTH];
   10          bit B_SPI_Busy; //发送忙标志
   11          
   12          
   13          //========================================================================
   14          // 函数: void   SPI_Init(SPI_InitTypeDef *SPIx)
   15          // 描述: SPI初始化程序.
   16          // 参数: SPIx: 结构参数,请参考spi.h里的定义.
   17          // 返回: none.
   18          // 版本: V1.0, 2012-11-22
   19          //========================================================================
   20          void SPI_Init(SPI_InitTypeDef *SPIx)
   21          {
   22   1              if(SPIx->SPI_SSIG == ENABLE)                    SSIG = 1;       //conform Master or Slave by SPI_Mode(ignore SS)
   23   1              else                                                                    SSIG = 0;       //conform Master or Slave by SS pin.
   24   1              SPI_Start(SPIx->SPI_Enable);
   25   1              SPI_FirstBit_Set(SPIx->SPI_FirstBit);
   26   1              SPI_Mode_Set(SPIx->SPI_Mode);
   27   1              SPI_CPOL_Set(SPIx->SPI_CPOL);
   28   1              SPI_CPHA_Set(SPIx->SPI_CPHA);
   29   1              SPI_Clock_Select(SPIx->SPI_Speed);
   30   1      
   31   1              SPI_RxTimerOut = 0;     //中断服务中
   32   1          SPI_Wait_time_out=0;
   33   1              B_SPI_Busy = 0;
   34   1      }
   35          
   36          //========================================================================
   37          // 函数: void SPI_SetMode(u8 mode)
   38          // 描述: SPI设置主从模式函数.
   39          // 参数: mode: 指定模式, 取值 SPI_Mode_Master 或 SPI_Mode_Slave.
   40          // 返回: none.
   41          // 版本: V1.0, 2012-11-22
   42          //========================================================================
   43          void SPI_SetMode(u8 mode)
   44          {
   45   1              if(mode == SPI_Mode_Slave)
   46   1              {
   47   2                      MSTR = 0;       //重新设置为从机待机
   48   2                      SSIG = 0;       //SS引脚确定主从
   49   2              }
   50   1              else
   51   1              {
   52   2                      MSTR = 1;       //使能 SPI 主机模式
   53   2                      SSIG = 1;       //忽略SS引脚功能
   54   2              }
   55   1      }
   56          
   57          //========================================================================
C251 COMPILER V5.60.0,  AI8051U_SPI                                                        18/11/25  13:45:59  PAGE 2   

   58          // 函数: void SPI_WriteByte(u8 dat)
   59          // 描述: SPI发送一个字节数据.
   60          // 参数: dat: 要发送的数据.
   61          // 返回: none.
   62          // 版本: V1.0, 2020-09-14
   63          //========================================================================
   64          void SPI_WriteByte(u8 dat)              //SPI发送一个字节数据
   65          {
   66   1              if(ESPI)
   67   1              {
   68   2                      B_SPI_Busy = 1;
   69   2                      SPDAT = dat;
   70   2                      while(B_SPI_Busy)  //中断模式
   71   2              {
   72   3                if(SPI_Wait_time_out++>5)          //20ms超时退出 
   73   3                {
   74   4                    SPI_Wait_time_out=0;
   75   4                    break;
   76   4                }
   77   3                delay_ms(2); 
   78   3              }
   79   2              }
   80   1              else
   81   1              {
   82   2                      SPDAT = dat;
   83   2                      while(SPIF == 0) //查询模式
   84   2              {
   85   3                if(SPI_Wait_time_out++>5)          //20ms超时退出 
   86   3                {
   87   4                    SPI_Wait_time_out=0;
   88   4                    break;
   89   4                }
   90   3                delay_ms(2);
   91   3              }
   92   2                      SPI_ClearFlag();   //清除SPIF和WCOL标志
   93   2              }
   94   1      }
   95          
   96          //========================================================================
   97          // 函数: void SPI_ReadByte(u8 dat)
   98          // 描述: SPI查询模式读取一个字节数据.
   99          // 参数: none.
  100          // 返回: 读取的数据.
  101          // 版本: V1.0, 2020-09-14
  102          //========================================================================
  103          
  104          u8 SPI_ReadByte(void)
  105          {
  106   1              SPDAT = 0xff;
  107   1              while(SPIF == 0)
  108   1          {
  109   2            if(SPI_Wait_time_out++>5)          //20ms超时退出 
  110   2            {
  111   3                SPI_Wait_time_out=0;
  112   3                break;
  113   3            }
  114   2            delay_ms(2);
  115   2          }
  116   1              SPI_ClearFlag();   //清0 SPIF和WCOL标志
  117   1              return (SPDAT);
  118   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       260     ------
  ecode size           =    ------     ------
C251 COMPILER V5.60.0,  AI8051U_SPI                                                        18/11/25  13:45:59  PAGE 3   

  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =       130     ------
  bit size             =         1     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =         5     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
