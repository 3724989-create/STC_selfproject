C251 COMPILER V5.60.0,  LQ_MotorServo                                                      18/11/25  13:45:55  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE LQ_MotorServo
OBJECT MODULE PLACED IN .\OBJ_Out\LQ_MotorServo.obj
COMPILER INVOKED BY: D:\MDK\C251\BIN\C251.EXE ..\..\libraries\LQ_LIB\Src\LQ_MotorServo.c XSMALL UNSIGNED_CHAR FLOAT64 BR
                    -OWSE INCDIR(..\..\libraries\Driver;..\..\libraries\Include;..\..\libraries\Driver\Inc;..\..\libraries\LQ_LIB\Inc;..\User
                    -) DEFINE(AI8051U_32Bit) DEBUG PRINT(.\OBJ_Out\LQ_MotorServo.lst) OBJECT(.\OBJ_Out\LQ_MotorServo.obj) 

stmt  level    source

    1          /*LLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLL
    2           ¡¾Æ½    Ì¨¡¿±±¾©ÁúÇñÖÇÄÜ¿Æ¼¼STC32Î»ºËÐÄ°å
    3           ¡¾±à    Ð´¡¿ÁúÇñ¿Æ¼¼
    4           ¡¾E-mail  ¡¿chiusir@163.com
    5           ¡¾Èí¼þ°æ±¾¡¿V1.0 °æÈ¨ËùÓÐ£¬µ¥Î»Ê¹ÓÃÇëÏÈÁªÏµÊÚÈ¨
    6           ¡¾Ïà¹ØÐÅÏ¢²Î¿¼ÏÂÁÐµØÖ·¡¿
    7           ¡¾Íø    Õ¾¡¿http://www.lqist.cn
    8           ¡¾ÌÔ±¦µêÆÌ¡¿http://longqiu.taobao.com
    9           --------------------------------------------------------------------------------
   10           ¡¾  IDE  ¡¿ keil C251 V5.60
   11           ¡¾Target ¡¿ STC32G/STC8051U/AI8051U 32Î»Ä£Ê½
   12           ¡¾SYS CLK¡¿ 42 MHzÊ¹ÓÃÄÚ²¿¾§Õñ
   13          QQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQ*/
   14          
   15          //#include "LQ_MotorServo.h"
   16          #include "include.h"
   17          
   18          
   19          #ifdef USE7971
               
               /**************************************************************************************
                * º¯ Êý Ãû£ºvoid Motor_Init(u16 freq)
                * ¹¦    ÄÜ£ºµç»úPWM³õÊ¼»¯ ÊÊÓÃÓÚ7971Çý¶¯
                * ²Î    Êý£ºu16 freq£ºÉèÖÃ²úÉúPWMµÄÆµÂÊ£¬Ò²¾ö¶¨Êä³öPWMµÄÂúÕ¼¿Õ±ÈÊ±¼ä
                * ×÷    Õß£ºLQ008
                * ×îºó¸üÐÂ: 2024Äê11ÔÂ17ÈÕ
                * Èí¼þ°æ±¾: V1.0
                * µ÷ÓÃ¾ÙÀý: MotorInit(12500)  //12.5KHZ   @45.1584MHzÊ±×î´óÕ¼¿Õ±ÈÊ±¼äÉèÖÃÖµ0~3613
                *           PWMÆµÂÊ (¼ÆËã·½Ê½£ºPeriod»òfreq = (u16)(MAIN_Fosc/freq)
                **************************************************************************************/
               void Motor_Init(u16 freq)
               {
                       PWMx_InitDefine         PWMx_InitStructure;
               
                   PWMx_Duty PWMB_Duty;
                   PWMB_Duty.PWM5_Duty = 0;
                   PWMB_Duty.PWM6_Duty = 0;
                   PWMB_Duty.PWM7_Duty = 0;
                   PWMB_Duty.PWM8_Duty = 0;
               
                   u16 PWMx_Period = (u16)(MAIN_Fosc / freq);
               
                   //PWM5ÉèÖÃ
                       PWMx_InitStructure.PWM_Mode      = CCMRn_PWM_MODE1;     //Ä£Ê½, CCMRn_FREEZE,CCMRn_MATCH_VALID,CCMRn_MAT
             -CH_INVALID,CCMRn_ROLLOVER,CCMRn_FORCE_INVALID,CCMRn_FORCE_VALID,CCMRn_PWM_MODE1,CCMRn_PWM_MODE2
                       PWMx_InitStructure.PWM_Duty      = 0;                   //PWMÕ¼¿Õ±ÈÊ±¼ä, 0~Period
                       PWMx_InitStructure.PWM_EnoSelect = ENO5P;               //Êä³öÍ¨µÀÑ¡Ôñ, ENO1P,ENO1N,ENO2P,ENO2N,ENO3P,EN
             -O3N,ENO4P,ENO4N / ENO5P,ENO6P,ENO7P,ENO8P
                       PWM_Configuration(PWM5, &PWMx_InitStructure);               //Ê¼»¯PWM5,  PWMB
                   //PWM6ÉèÖÃ
                       PWMx_InitStructure.PWM_Mode      = CCMRn_PWM_MODE1;     //Ä£Ê½, CCMRn_FREEZE,CCMRn_MATCH_VALID,CCMRn_MAT
             -CH_INVALID,CCMRn_ROLLOVER,CCMRn_FORCE_INVALID,CCMRn_FORCE_VALID,CCMRn_PWM_MODE1,CCMRn_PWM_MODE2
                       PWMx_InitStructure.PWM_Duty      = 0;                   //PWMÕ¼¿Õ±ÈÊ±¼ä, 0~Period
                       PWMx_InitStructure.PWM_EnoSelect =ENO6P;                //Êä³öÍ¨µÀÑ¡Ôñ, ENO1P,ENO1N,ENO2P,ENO2N,ENO3P,EN
             -O3N,ENO4P,ENO4N / ENO5P,ENO6P,ENO7P,ENO8P
                       PWM_Configuration(PWM6, &PWMx_InitStructure);                   //Ê¼»¯PWM6,   PWMB
                   //PWM7ÉèÖÃ
C251 COMPILER V5.60.0,  LQ_MotorServo                                                      18/11/25  13:45:55  PAGE 2   

                       PWMx_InitStructure.PWM_Mode      = CCMRn_PWM_MODE1;     //Ä£Ê½, CCMRn_FREEZE,CCMRn_MATCH_VALID,CCMRn_MAT
             -CH_INVALID,CCMRn_ROLLOVER,CCMRn_FORCE_INVALID,CCMRn_FORCE_VALID,CCMRn_PWM_MODE1,CCMRn_PWM_MODE2
                       PWMx_InitStructure.PWM_Duty      = 0;                   //PWMÕ¼¿Õ±ÈÊ±¼ä, 0~Period
                       PWMx_InitStructure.PWM_EnoSelect = ENO7P;               //Êä³öÍ¨µÀÑ¡Ôñ, ENO1P,ENO1N,ENO2P,ENO2N,ENO3P,EN
             -O3N,ENO4P,ENO4N / ENO5P,ENO6P,ENO7P,ENO8P
                       PWM_Configuration(PWM7, &PWMx_InitStructure);           //Ê¼»¯PWM7,   PWMB
                   //PWM8ÉèÖÃ
                       PWMx_InitStructure.PWM_Mode      = CCMRn_PWM_MODE1;     //Ä£Ê½, CCMRn_FREEZE,CCMRn_MATCH_VALID,CCMRn_MAT
             -CH_INVALID,CCMRn_ROLLOVER,CCMRn_FORCE_INVALID,CCMRn_FORCE_VALID,CCMRn_PWM_MODE1,CCMRn_PWM_MODE2
                       PWMx_InitStructure.PWM_Duty      = 0;                   //PWMÕ¼¿Õ±ÈÊ±¼ä, 0~Period
                       PWMx_InitStructure.PWM_EnoSelect = ENO8P;               //Êä³öÍ¨µÀÑ¡Ôñ, ENO1P,ENO1N,ENO2P,ENO2N,ENO3P,EN
             -O3N,ENO4P,ENO4N / ENO5P,ENO6P,ENO7P,ENO8P
                       PWM_Configuration(PWM8, &PWMx_InitStructure);           //Ê¼»¯PWM8,  PWMB
                   //PWMB Í¨µÀ5~8ÉèÖÃ
                       PWMx_InitStructure.PWM_Period        = PWMx_Period;     //ÖÜÆÚÊ±¼ä,  0~Period   (¼ÆËã·½Ê½£ºPeriod = MAIN
             -_Fosc/freq)
                       PWMx_InitStructure.PWM_DeadTime      = 0;               //Çø·¢ÉúÆ÷ÉèÖÃ, 0~255
                       PWMx_InitStructure.PWM_MainOutEnable = ENABLE;          //Êä³öÊ¹ÄÜ, ENABLE,DISABLE
                       PWMx_InitStructure.PWM_CEN_Enable    = ENABLE;          //ÄÜ¼ÆÊýÆ÷, ENABLE,DISABLE
                       PWM_Configuration(PWMB, &PWMx_InitStructure);           //Ê¼»¯PWMÍ¨ÓÃ¼Ä´æÆ÷,  PWMA,PWMB
               
                   //PWMB Í¨µÀ5-8 Êä³ö¹Ü½ÅÑ¡Ôñ
                   PWM5_USE_P50();
                   PWM6_USE_P51();
                   PWM7_USE_P52();
                   PWM8_USE_P53();
               
                   //PWMÊä³ö¹Ü½ÅÉèÖÃ£¨Æô¶¯PWM¹¦ÄÜºóÊä³ö½Å×Ô¶¯ÉèÖÃÎªÍÆÍìÊä³öÄ£Ê½ AI8051UÐèÒªÊÖ¶¯ÉèÖÃÍÆÍìÊä³ö£©
                       P5_MODE_OUT_PP(GPIO_Pin_LOW);               //P50~P53ËÄ¸ö¹Ü½ÅPWMÊä³öÄ£Ê½ÉèÎª ÍÆÍìÊä³ö
               
                       NVIC_PWM_Init(PWMB,DISABLE,Priority_0);     //PWMA,NVICÖÐ¶ÏÉèÖÃ£¬ÓÅÏÈ¼¶¿É¸ù¾ÝÊµ¼ÊÇé¿öÊÊµ±µ÷Õû
               
                   UpdatePwm(PWMB, &PWMB_Duty);
               }
               
               
               /*********************************************************************************
                * º¯ Êý Ãû£ºvoid Motor_Ctrl(int16 Motor1, int16 Motor2)
                * ¹¦    ÄÜ£º7971Ë«Â·µç»ú¿ØÖÆº¯Êý
                * ²Î Êý Öµ£ºMotor1£ºµç»ú1Õ¼¿Õ±È£»Motor2£ºµç»ú2Õ¼¿Õ±È
                * ·µ »Ø Öµ£ºÎÞ
                * ×÷    Õß£ºLQ008
                * ×îºó¸üÐÂ£º2024Äê11ÔÂ17ÈÕ
                * Èí¼þ°æ±¾£ºV1.0
                * µ÷ÓÃ¾ÙÀý£ºMotorCtrl (1000,-2000); //Á½¸öµç»úÒ»ÕýÒ»·´×ª¶¯
                **********************************************************************************/
               void Motor_Ctrl (int16 Motor1,int16 Motor2)
               {
                 if (Motor1 < 0)
                 {
                     Motor1=0-Motor1;
                     UpdatePwmCh(PWM5, 0);
                     UpdatePwmCh(PWM6, Motor1);
                 }
                 else
                 {
                     UpdatePwmCh(PWM5, Motor1);
                     UpdatePwmCh(PWM6, 0);
                 }
               
                 if (Motor2 < 0)
                 {
                     Motor2=0-Motor2;
                     UpdatePwmCh(PWM7, 0);
                     UpdatePwmCh(PWM8, Motor1);
                 }
C251 COMPILER V5.60.0,  LQ_MotorServo                                                      18/11/25  13:45:55  PAGE 3   

                 else
                 {
                     UpdatePwmCh(PWM7, Motor1);
                     UpdatePwmCh(PWM8, 0);
                 }
               }
               
               
                /*  USE7971*/
               
               #elif defined USEDRV8701
  126          /**************************************************************************************
  127           * º¯ Êý Ãû£ºvoid Motor_Init(u16 freq)
  128           * ¹¦    ÄÜ£ºµç»úPWM³õÊ¼»¯   ÊÊÓÃÓÚ8701Çý¶¯
  129           * ·µ »Ø Öµ£ºÎÞ
  130           * ×÷    Õß£ºLQ008
  131           * ×îºó¸üÐÂ: 2024Äê11ÔÂ17ÈÕ
  132           * Èí¼þ°æ±¾: V1.0
  133           * µ÷ÓÃ¾ÙÀý: MotorInit();  //12.5KHz @45.1584MHzÊ±×î´óÕ¼¿Õ±ÈÊ±¼äÉèÖÃÖµÎª0~3613
  134           *           PWMÆµÂÊ ¼ÆËã·½Ê½£ºPeriod = (u16)(MAIN_Fosc/freq)  ×ÔÊÊÓ¦Ö÷Æµ
  135           **************************************************************************************/
  136          void Motor_Init(u16 freq)
  137          {
  138   1              PWMx_InitDefine         PWMx_InitStructure;
  139   1      
  140   1          u16 PWMx_Period = (u16)(MAIN_Fosc / freq);
  141   1          //PWM5ÉèÖÃ
  142   1              PWMx_InitStructure.PWM_Mode      = CCMRn_PWM_MODE1;     //Ä£Ê½, CCMRn_FREEZE,CCMRn_MATCH_VALID,CCMRn_MAT
             -CH_INVALID,CCMRn_ROLLOVER,CCMRn_FORCE_INVALID,CCMRn_FORCE_VALID,CCMRn_PWM_MODE1,CCMRn_PWM_MODE2
  143   1              PWMx_InitStructure.PWM_Duty      = 0;                   //PWMÕ¼¿Õ±ÈÊ±¼ä, 0~Period
  144   1              PWMx_InitStructure.PWM_EnoSelect = ENO5P;               //Êä³öÍ¨µÀÑ¡Ôñ, ENO1P,ENO1N,ENO2P,ENO2N,ENO3P,EN
             -O3N,ENO4P,ENO4N / ENO5P,ENO6P,ENO7P,ENO8P
  145   1              PWM_Configuration(PWM5, &PWMx_InitStructure);               //Ê¼»¯PWM5,  PWMB
  146   1      //    //PWM6ÉèÖÃ
  147   1      //      PWMx_InitStructure.PWM_Mode      = CCMRn_PWM_MODE1;     //Ä£Ê½, CCMRn_FREEZE,CCMRn_MATCH_VALID,CCMRn_M
             -ATCH_INVALID,CCMRn_ROLLOVER,CCMRn_FORCE_INVALID,CCMRn_FORCE_VALID,CCMRn_PWM_MODE1,CCMRn_PWM_MODE2
  148   1      //      PWMx_InitStructure.PWM_Duty      = 0;                   //PWMÕ¼¿Õ±ÈÊ±¼ä, 0~Period
  149   1      //      PWMx_InitStructure.PWM_EnoSelect =ENO6P;                //Êä³öÍ¨µÀÑ¡Ôñ, ENO1P,ENO1N,ENO2P,ENO2N,ENO3P,
             -ENO3N,ENO4P,ENO4N / ENO5P,ENO6P,ENO7P,ENO8P
  150   1      //      PWM_Configuration(PWM6, &PWMx_InitStructure);                   //Ê¼»¯PWM6,   PWMB
  151   1          //PWM7ÉèÖÃ
  152   1              PWMx_InitStructure.PWM_Mode      = CCMRn_PWM_MODE1;     //Ä£Ê½, CCMRn_FREEZE,CCMRn_MATCH_VALID,CCMRn_MAT
             -CH_INVALID,CCMRn_ROLLOVER,CCMRn_FORCE_INVALID,CCMRn_FORCE_VALID,CCMRn_PWM_MODE1,CCMRn_PWM_MODE2
  153   1              PWMx_InitStructure.PWM_Duty      = 0;                   //PWMÕ¼¿Õ±ÈÊ±¼ä, 0~Period
  154   1              PWMx_InitStructure.PWM_EnoSelect = ENO7P;               //Êä³öÍ¨µÀÑ¡Ôñ, ENO1P,ENO1N,ENO2P,ENO2N,ENO3P,EN
             -O3N,ENO4P,ENO4N / ENO5P,ENO6P,ENO7P,ENO8P
  155   1              PWM_Configuration(PWM7, &PWMx_InitStructure);           //Ê¼»¯PWM7,   PWMB
  156   1      //    //PWM8ÉèÖÃ
  157   1      //      PWMx_InitStructure.PWM_Mode      = CCMRn_PWM_MODE1;     //Ä£Ê½, CCMRn_FREEZE,CCMRn_MATCH_VALID,CCMRn_M
             -ATCH_INVALID,CCMRn_ROLLOVER,CCMRn_FORCE_INVALID,CCMRn_FORCE_VALID,CCMRn_PWM_MODE1,CCMRn_PWM_MODE2
  158   1      //      PWMx_InitStructure.PWM_Duty      = 0;                   //PWMÕ¼¿Õ±ÈÊ±¼ä, 0~Period
  159   1      //      PWMx_InitStructure.PWM_EnoSelect = ENO8P;               //Êä³öÍ¨µÀÑ¡Ôñ, ENO1P,ENO1N,ENO2P,ENO2N,ENO3P,
             -ENO3N,ENO4P,ENO4N / ENO5P,ENO6P,ENO7P,ENO8P
  160   1      //      PWM_Configuration(PWM8, &PWMx_InitStructure);           //Ê¼»¯PWM8,  PWMB
  161   1          //PWMA Í¨µÀ1~4ÉèÖÃ
  162   1              PWMx_InitStructure.PWM_Period        = PWMx_Period;     //ÖÜÆÚÊ±¼ä,  0~Period   (¼ÆËã·½Ê½£ºPeriod = MAIN
             -_Fosc/freq)
  163   1              PWMx_InitStructure.PWM_DeadTime      = 0;               //Çø·¢ÉúÆ÷ÉèÖÃ, 0~255
  164   1              PWMx_InitStructure.PWM_MainOutEnable = ENABLE;          //Êä³öÊ¹ÄÜ, ENABLE,DISABLE
  165   1              PWMx_InitStructure.PWM_CEN_Enable    = ENABLE;          //ÄÜ¼ÆÊýÆ÷, ENABLE,DISABLE
  166   1              PWM_Configuration(PWMB, &PWMx_InitStructure);           //Ê¼»¯PWMÍ¨ÓÃ¼Ä´æÆ÷,  PWMA,PWMB
  167   1          
  168   1      #ifdef AI8051U_32Bit   //Èç¹ûÊÇSTC32,Ñ¡ÔñPWM¹Ü½Åºó ÐèÒª¶ÔÓ¦ÐÞ¸ÄGIO³õÊ¼»¯£¬ÒÔÏÂÖ÷ÒªÕë¶ÔAI8051U£¬Ê¹ÓÃSTC32G
             -µÄ×ÔÐÐÐÞ¸Ä
  169   1          //PWMB Í¨µÀ5-8 Êä³ö¹Ü½ÅÑ¡Ôñ
  170   1          PWM5_USE_P50();
C251 COMPILER V5.60.0,  LQ_MotorServo                                                      18/11/25  13:45:55  PAGE 4   

  171   1      //    PWM6_USE_P51();       //ÉèÎªIO,×ö8701·½Ïò¿ØÖÆIO1
  172   1          PWM7_USE_P52();
  173   1      //    PWM8_USE_P53();       //ÉèÎªIO,×ö8701·½Ïò¿ØÖÆIO2
  174   1      #endif
  175   1          //PWMÊä³ö¹Ü½ÅÉèÖÃ£¨Æô¶¯PWM¹¦ÄÜºóÊä³ö½Å×Ô¶¯ÉèÖÃÎªÍÆÍìÊä³öÄ£Ê½ AI8051UÐèÒªÊÖ¶¯ÉèÖÃÍÆÍìÊä³ö£©
  176   1              P5_MODE_OUT_PP(GPIO_Pin_0|GPIO_Pin_2);      //PWMÊä³ö¹Ü½ÅÄ£Ê½ÉèÎª ÍÆÍìÊä³ö
  177   1      
  178   1          //µç»úÇý¶¯·½Ïò¿ØÖÆIO³õÊ¼»¯
  179   1          P5_MODE_OUT_PP(GPIO_Pin_1|GPIO_Pin_3);      //ÉèÎªIO,×ö8701·½Ïò¿ØÖÆIO,ÍÆÍìÊä³öÄ¬ÈÏ¸ßµçÆ½
  180   1          GPIO_Write_Pin(Motor_Dir1,RESET);           //ÉèÎªµÍµçÆ½
  181   1          GPIO_Write_Pin(Motor_Dir2,RESET);
  182   1      
  183   1              NVIC_PWM_Init(PWMB,DISABLE,Priority_0);     //PWMA,NVICÖÐ¶ÏÉèÖÃ£¬ÓÅÏÈ¼¶¿É¸ù¾ÝÊµ¼ÊÇé¿öÊÊµ±µ÷Õû
  184   1          UpdatePwmCh(PWM5, 0);                       //Òª¸üÐÂµÄÍ¨µÀÒÔ¼°Õ¼¿Õ±ÈÊ±¼ä
  185   1          UpdatePwmCh(PWM7, 0);
  186   1      //    UpdatePwm(PWMB, &PWMB_Duty);      //´Ë·¨ÊÊºÏÒ»´Î¸üÐÂÒ»×é¶àÍ¨µÀ£¬µ«ÐèÒªÏÈ³õÊ¼»¯½á¹¹Ìå²¢¸øÃ¿¸öÍ¨µÀ¸³Ö
             -µ£¬eg:PWMx_Duty PWMB_Duty;PWMB_Duty.PWM5_Duty=1200;
  187   1      }
  188          
  189          
  190          /**************************************************************************************
  191           * º¯ Êý Ãû£ºvoid Motor_Ctrl(int16 Motor1,int16 Motor2)
  192           * ¹¦    ÄÜ£ºLQDRV8701Ë«Â·µç»ú¿ØÖÆº¯Êý
  193           * ²Î    Êý£ºMotor1£ºµç»ú1Õ¼¿Õ±È£»Motor2£ºµç»ú2Õ¼¿Õ±È
  194           * ·µ »Ø Öµ£ºÎÞ
  195           * ×÷    Õß£ºLQ008
  196           * ×îºó¸üÐÂ: 2024Äê11ÔÂ17ÈÕ
  197           * Èí¼þ°æ±¾: V1.0
  198           * µ÷ÓÃ¾ÙÀý: MotorInit(12500)  //12.5KHz @45.1584MHz
  199           *           PWMÆµÂÊ ¼ÆËã·½Ê½£ºPeriod = (u16)(MAIN_Fosc/freq)
  200           **************************************************************************************/
  201          void Motor_Ctrl(int16 Motor1,int16 Motor2)
  202          {
  203   1        if (Motor1 < 0)
  204   1        {
  205   2            Motor1 = 0-Motor1;
  206   2            Motor_Dir1 = SET;
  207   2            UpdatePwmCh(PWM5, Motor1);      //0~3614@45.158MHzÖ÷ÆµÊ±
  208   2        }
  209   1        else
  210   1        {
  211   2            Motor_Dir1 = RESET;
  212   2            UpdatePwmCh(PWM5, Motor1);      //0~3614
  213   2        }
  214   1      
  215   1        if (Motor2 < 0)
  216   1        {
  217   2            Motor2 = 0-Motor2;
  218   2            Motor_Dir2 = SET;
  219   2            UpdatePwmCh(PWM7, Motor2);
  220   2        }
  221   1        else
  222   1        {
  223   2            Motor_Dir2 = RESET;
  224   2            UpdatePwmCh(PWM7, Motor2);
  225   2        }
  226   1      }
  227          
  228          
  229          #endif    /*  USE8701*/
  230          
  231          /**************************************************************************************
  232           *  º¯ Êý Ãû£ºTest_Motor(void)
  233           *  ¹¦    ÄÜ£º²âÊÔ±ê¶¨Êä³öPWM¿ØÖÆµç»ú ,×¢ÒâÊ¹ÓÃÄÄ¸öÇý¶¯ÐèÒªÔÚÍ·ÎÄ¼þÖÐÇÐ»»ºê¶¨Òå
  234           *  ²Î    Êý£ºÎÞ
  235           *  ·µ »Ø Öµ£ºÎÞ
C251 COMPILER V5.60.0,  LQ_MotorServo                                                      18/11/25  13:45:55  PAGE 5   

  236           *  ×÷    Õß£ºLQ008
  237           *  ×îºó¸üÐÂ£º2024Äê11ÔÂ17ÈÕ
  238           *  Èí¼þ°æ±¾£ºV1.0
  239           *  µ÷ÓÃ¾ÙÀý£º
  240           *  ×¢ÒâÊÂÏî£º×¢Òâ£¬Ò»¶¨ÒªÏÈÈ·¶¨µç³ØµçÑ¹Óëµç»ú¶î¶¨µçÑ¹ È»ºó¶Ôµç»úÊä³ö½øÐÐÏÞÖÆ£¬ÒÔÃâËð»µµç»úµÈÆ÷¼þ
  241          ------------------------------------------------------------------------------------
  242           * Ê¹ÓÃÁúÇñÄ¸°å²âÊÔµç»ú¼°Çý¶¯Á÷³Ì£º
  243           * 1.ÏÈÊ¹ÓÃÍòÓÃ±í²âÁ¿µç³ØµçÑ¹£¬Îñ±Ø±£Ö¤µç³ØµçÑ¹ÔÚ7VÒÔÉÏ£¬·ñÔò¿ÉÄÜÎÞÁ¦²»·´Ó¦£¡
  244           * 2.½ÓºÃÄ¸°åµ½Çý¶¯°åµÄÐÅºÅÏß¼°µçÔ´Ïß£»
  245           * 3.½ÓºÃÇý¶¯°åµ½µç»úµÄµ¼Ïß£»
  246           * 4.ÉÕÐ´³ÌÐò²¢ÔËÐÐ£¬È·¶¨µç»úÄÜÕý³£×ª¶¯ºó£¬¿ªÆôÇý¶¯°åµçÔ´¿ª¹Ø£»
  247           * 5.°´¼üK1/K3È·¶¨µç»ú×ª¶¯ËÙ¶È¼°·½Ïò£»
  248           * 6.Èç¹û³öÏÖ·è×ª£¬°´ÏÂK1¼ü·µ»ØµÍËÙÄ£Ê½£¬»òÕßÖ±½Ó¹Ø±ÕÇý¶¯°åµçÔ´£¡
  249           **************************************************************************************/
  250          void Test_Motor (void)
  251          {
  252   1        short duty = 00;
  253   1        char txt[16];
  254   1          
  255   1        Motor_Init(Motor_FREQ);   //³õÊ¼»¯µç»úPWM£¬²ÎÊýPWMÆµÂÊ 
  256   1        //Èç¹ûÊÇSTC32,Ñ¡ÔñPWM¹Ü½Åºó ÐèÒª¶ÔÓ¦ÐÞ¸ÄGIO³õÊ¼»¯£¬ÒÔÏÂÖ÷ÒªÕë¶ÔAI8051U£¬Ê¹ÓÃSTC32GµÄ×ÔÐÐÐÞ¸Ä
  257   1      
  258   1        OLED_Init();
  259   1        OLED_CLS();                                                   // ÇåÆÁ
  260   1        OLED_P8x16Str(2, 0, "LQ Motor Test");
  261   1      //  Motor_Init(Motor_FREQ);                          // µç»ú³õÊ¼»¯
  262   1      
  263   1      //  printf("F:%.0f\n",MAIN_Fosc/12500.0);
  264   1        while (1)
  265   1        {
  266   2          if (KEY_Read(KEY0) == 0)            // °´ÏÂKEY0¼ü£¬Õ¼¿Õ±È¼õÐ¡
  267   2          {
  268   3                      if (duty > -3360)               // ÂúÕ¼¿Õ±ÈÎª3360 @42 MHzÖ÷Æµ MAIN_Fosc/12500
  269   3              duty -= 50;
  270   3          }
  271   2          if (KEY_Read(KEY2) == 0)            // °´ÏÂKEY2¼ü£¬Õ¼¿Õ±È¼Ó´ó
  272   2          {
  273   3                      if (duty <3360)
  274   3              duty += 50;
  275   3          }
  276   2          if (KEY_Read(KEY1) == 0)            // °´ÏÂKEY1¼ü£¬Õ¼¿Õ±ÈÖÐÖµ
  277   2          {
  278   3            duty = 50;
  279   3          }
  280   2      
  281   2      
  282   2          Motor_Ctrl(duty,duty);
  283   2      
  284   2          sprintf(txt, "PWM: %05d;", duty);
  285   2          OLED_P8x16Str(0, 4, txt);           // ×Ö·û´®ÏÔÊ¾
  286   2      //    UART1_PutStr(txt);
  287   2      
  288   2          LED_Ctrl(LED0, RVS);                // µçÆ½·­×ª,LEDÉÁË¸
  289   2          delay_ms(100);                      // ÑÓÊ±µÈ´ý
  290   2        }
  291   1      
  292   1      }
  293          
  294          
  295          
  296          
  297          
  298          
  299          
  300          /**********************************************************************************
  301           * º¯ Êý Ãû£ºvoid Servo_Init(u16 freq)
C251 COMPILER V5.60.0,  LQ_MotorServo                                                      18/11/25  13:45:55  PAGE 6   

  302           * ¹¦    ÄÜ£º¶æ»úPWM³õÊ¼»¯
  303           * ²Î Êý Öµ£º¶æ»úPWMµÄÆµÂÊ  Ò»°ã50»ò100 Hz
  304           * ·µ »Ø Öµ£ºÎÞ
  305           * ×÷    Õß£ºchiusir
  306           * ×îºó¸üÐÂ£º2024Äê11ÔÂ17ÈÕ
  307           * Èí¼þ°æ±¾£ºV1.0
  308           * µ÷ÓÃ¾ÙÀý£ºÇý¶¯¶æ»ú ServoInit(100);  //100Hz
  309           *           PWMÆµÂÊ ¼ÆËã·½Ê½£ºPeriod = (u16)(MAIN_Fosc/freq)  ×ÔÊÊÓ¦Ö÷Æµ
  310           ***********************************************************************************/
  311          void Servo_Init(u16 freq)
  312          {
  313   1              PWMx_InitDefine         PWMx_InitStructure;
  314   1              /* ×¢ÒâÕâÀïµÄ¹Ü½ÅÑ¡ÔñÓëÊä³öÊ¹ÄÜ£¬PWA¾ßÓÐ»¥²¹Êä³ö¹¦ÄÜ£¬Òò´ËÓÃ²»µ½»¥²¹¹Ü½ÅÊä³ö£¬ÔòÐèÒªENOxN½ûÖ¹Êä³ö*/
  315   1          /* PWM_EnoSelect = ENO1P|ENO1N;  //¼´Í¨µÀ1Êä³ö»¥²¹PWM£¬Á½¸ö¹Ü½ÅÕ¼¿Õ±È»¥²¹*/
  316   1      
  317   1          PWMA_Prescaler((MAIN_Fosc / 1000000 - 1));              //PWMÊ±ÖÓ Ô¤·ÖÆµÆ÷ÉèÖÃ PWM·ÖÆµµ½1M·¶Î§
  318   1          //PWM1ÉèÖÃ
  319   1              PWMx_InitStructure.PWM_Mode      = CCMRn_PWM_MODE1;     //Ä£Ê½, CCMRn_FREEZE,CCMRn_MATCH_VALID,CCMRn_MAT
             -CH_INVALID,CCMRn_ROLLOVER,CCMRn_FORCE_INVALID,CCMRn_FORCE_VALID,CCMRn_PWM_MODE1,CCMRn_PWM_MODE2
  320   1              PWMx_InitStructure.PWM_Duty      = 0;                   //PWMÕ¼¿Õ±ÈÊ±¼ä, 0~Period
  321   1              PWMx_InitStructure.PWM_EnoSelect = ENO1P;               //Êä³öÍ¨µÀÑ¡Ôñ, ENO1P,ENO1N,ENO2P,ENO2N,ENO3P,EN
             -O3N,ENO4P,ENO4N / ENO5P,ENO6P,ENO7P,ENO8P
  322   1              PWM_Configuration(PWM1, &PWMx_InitStructure);           //³õÊ¼»¯PWM1,  PWMA
  323   1          //PWM2ÉèÖÃ
  324   1              PWMx_InitStructure.PWM_Mode      = CCMRn_PWM_MODE1;     //Ä£Ê½, CCMRn_FREEZE,CCMRn_MATCH_VALID,CCMRn_MAT
             -CH_INVALID,CCMRn_ROLLOVER,CCMRn_FORCE_INVALID,CCMRn_FORCE_VALID,CCMRn_PWM_MODE1,CCMRn_PWM_MODE2
  325   1              PWMx_InitStructure.PWM_Duty      = 0;                   //PWMÕ¼¿Õ±ÈÊ±¼ä, 0~Period
  326   1              PWMx_InitStructure.PWM_EnoSelect = ENO2P;               //Êä³öÍ¨µÀÑ¡Ôñ, ENO1P,ENO1N,ENO2P,ENO2N,ENO3P,EN
             -O3N,ENO4P,ENO4N / ENO5P,ENO6P,ENO7P,ENO8P
  327   1              PWM_Configuration(PWM2, &PWMx_InitStructure);           //³õÊ¼»¯PWM2,  PWMA
  328   1      //    //PWM3ÉèÖÃ
  329   1      //      PWMx_InitStructure.PWM_Mode      = CCMRn_PWM_MODE1;     //Ä£Ê½, CCMRn_FREEZE,CCMRn_MATCH_VALID,CCMRn_M
             -ATCH_INVALID,CCMRn_ROLLOVER,CCMRn_FORCE_INVALID,CCMRn_FORCE_VALID,CCMRn_PWM_MODE1,CCMRn_PWM_MODE2
  330   1      //      PWMx_InitStructure.PWM_Duty      = 0;                   //PWMÕ¼¿Õ±ÈÊ±¼ä, 0~Period
  331   1      //      PWMx_InitStructure.PWM_EnoSelect = ENO3P;               //Êä³öÍ¨µÀÑ¡Ôñ, ENO1P,ENO1N,ENO2P,ENO2N,ENO3P,
             -ENO3N,ENO4P,ENO4N / ENO5P,ENO6P,ENO7P,ENO8P
  332   1      //      PWM_Configuration(PWM3, &PWMx_InitStructure);           //³õÊ¼»¯PWM3,  PWMA
  333   1      //    //PWM4ÉèÖÃ
  334   1      //      PWMx_InitStructure.PWM_Mode      = CCMRn_PWM_MODE1;     //Ä£Ê½, CCMRn_FREEZE,CCMRn_MATCH_VALID,CCMRn_M
             -ATCH_INVALID,CCMRn_ROLLOVER,CCMRn_FORCE_INVALID,CCMRn_FORCE_VALID,CCMRn_PWM_MODE1,CCMRn_PWM_MODE2
  335   1      //      PWMx_InitStructure.PWM_Duty      = 0;                   //PWMÕ¼¿Õ±ÈÊ±¼ä, 0~Period
  336   1      //      PWMx_InitStructure.PWM_EnoSelect = ENO4P;               //Êä³öÍ¨µÀÑ¡Ôñ, ENO1P,ENO1N,ENO2P,ENO2N,ENO3P,
             -ENO3N,ENO4P,ENO4N / ENO5P,ENO6P,ENO7P,ENO8P
  337   1      //      PWM_Configuration(PWM4, &PWMx_InitStructure);           //³õÊ¼»¯PWM4,  PWMA
  338   1          //PWMA Í¨µÀ1~4ÉèÖÃ
  339   1              PWMx_InitStructure.PWM_Period        = (u16)(1000000/freq);    //ÖÜÆÚÊ±¼ä,   0~Period
  340   1              PWMx_InitStructure.PWM_DeadTime      = 0;               //ËÀÇø·¢ÉúÆ÷ÉèÖÃ, 0~255
  341   1              PWMx_InitStructure.PWM_MainOutEnable = ENABLE;          //Ö÷Êä³öÊ¹ÄÜ, ENABLE,DISABLE
  342   1              PWMx_InitStructure.PWM_CEN_Enable    = ENABLE;          //Ê¹ÄÜ¼ÆÊýÆ÷, ENABLE,DISABLE
  343   1              PWM_Configuration(PWMA, &PWMx_InitStructure);           //³õÊ¼»¯PWMÍ¨ÓÃ¼Ä´æÆ÷,  PWMA
  344   1      
  345   1          //PWMA Í¨µÀ1-4 Êä³ö¹Ü½ÅÑ¡Ôñ
  346   1          PWM1_USE_P10P11(); //½öÊ¹ÄÜP10Êä³ö¼´¿É£¬²»ÐèÒª»¥²¹¹Ü½ÅP11µÄÊä³ö£¬»¥²¹¹Ü½Å»¹¿É×öÆäËûÆÕÍ¨IOÊ¹ÓÃ
  347   1          PWM2_USE_P12P13();
  348   1      //    PWM3_USE_P14P15();
  349   1      //    PWM4_USE_P16P17();
  350   1      
  351   1          //PWMÊä³ö¹Ü½ÅÉèÖÃ£¨Æô¶¯PWM¹¦ÄÜºóÊä³ö½Å×Ô¶¯ÉèÖÃÎªÍÆÍìÊä³öÄ£Ê½ AI8051UÐèÒªÊÖ¶¯ÉèÖÃÍÆÍìÊä³ö£©
  352   1              P1_MODE_OUT_PP(GPIO_Pin_0|GPIO_Pin_2);
  353   1              NVIC_PWM_Init(PWMA,DISABLE,Priority_0);                     //PWMA,NVICÖÐ¶ÏÉèÖÃ
  354   1          UpdatePwmCh(PWM1, 0);                        //Òª¸üÐÂµÄÍ¨µÀÒÔ¼°Õ¼¿Õ±ÈÊ±¼ä
  355   1          UpdatePwmCh(PWM2, 0);
  356   1      //    UpdatePwmCh(PWM3, 0);                       //Òª¸üÐÂµÄÍ¨µÀÒÔ¼°Õ¼¿Õ±ÈÊ±¼ä
  357   1      //    UpdatePwmCh(PWM4, 0);
  358   1      //    UpdatePwm(PWMA, &PWMA_Duty);
  359   1      
C251 COMPILER V5.60.0,  LQ_MotorServo                                                      18/11/25  13:45:55  PAGE 7   

  360   1      }
  361          /**********************************************************************************
  362           * º¯ Êý Ãû£ºvoid Servo_Ctrl (u16 duty)
  363           * ¹¦    ÄÜ£º¶æ»ú×ª½Çº¯Êý£¬ÓÉÓÚÐ¡³µÀ­¸Ë·¶Î§ÏÞÖÆ£¬½ÏÐ¡
  364           * ²Î Êý Öµ£ºshort Sduty£¬Õ¼¿Õ±È£¬·¶Î§0--10000£»
  365           * ×÷    Õß£ºLQ008
  366           * ×îºó¸üÐÂ£º2024Äê11ÔÂ17ÈÕ
  367           * Èí¼þ°æ±¾£ºV1.0
  368           * µ÷ÓÃ¾ÙÀý£ºServoCtrl(1500);//¶æ»úÖÐÖµ
  369           **********************************************************************************/
  370          void Servo_Ctrl(u8 Sx, u16 Sduty)
  371          {
  372   1        if (Sduty <= Servo_Median-1000)                  //ÏÞÖÆ·ùÖµ,¸ù¾ÝÊµ¼ÊÇé¿ö½øÐÐµ÷Õû
  373   1        {
  374   2            Sduty = Servo_Median-1000;
  375   2        }
  376   1        else if (Sduty >= Servo_Median+1000)            //ÏÞÖÆ·ùÖµ
  377   1        {
  378   2            Sduty = Servo_Median+1000;
  379   2        }
  380   1        if(Servo1==Sx)
  381   1            UpdatePwmCh(PWM1, Sduty);
  382   1        if(Servo1==Sx)
  383   1            UpdatePwmCh(PWM2, Sduty);
  384   1      }
  385          
  386          
  387          /******************************************************************************************
  388            * º¯ Êý Ãû£ºTest_Servo(void)
  389            * ¹¦    ÄÜ£º¶æ»úPWM¿ØÖÆ²âÊÔº¯Êý£¬²âÊÔ±ê¶¨Êä³öPWM¿ØÖÆSD5/S3010¶æ»ú
  390            * ²Î Êý Öµ£ºÎÞ
  391            * ·µ »Ø Öµ£ºÎÞ
  392            * ×÷    Õß£ºLQ008
  393            * ×îºó¸üÐÂ£º2024Äê11ÔÂ17ÈÕ
  394            * Èí¼þ°æ±¾£ºV1.0
  395            * ×¢ÒâÊÂÏî£º×¢Òâ£¬Ò»¶¨Òª¶Ô¶æ»ú´ò½Ç½øÐÐÏÞÖÆ   0.5ms~2.5ms ¶ÔÓ¦dutyÔÚ500~2600Ö®¼ä
  396              ----------------------------------------------------------------------------
  397            * Ê¹ÓÃÁúÇñÄ¸°å²âÊÔ¶æ»úÁ÷³Ì£º
  398            *  1.ÏÈÊ¹ÓÃÍòÓÃ±í²âÁ¿µç³ØµçÑ¹£¬Îñ±Ø±£Ö¤µç³ØµçÑ¹ÔÚ7VÒÔÉÏ£¬·ñÔòÎÞÁ¦²»·´Ó¦£¡
  399            *  2.È»ºóÈ·¶¨¶æ»ú¹©µçµçÑ¹£¬SD5¶æ»úÓÃ5V¹©µç£¬S3010ÓÃ6-7V¹©µç£¬SD012¶æ»úÓÃ5V¹©µç£¡£¡£¡
  400            *  3.°Ñ¶æ»úµÄ¶æÅÌÈ¥µô£¬ÈÃ¶æ»ú¿ÉÒÔ×ÔÓÉ×ª¶¯£»
  401            *  4.ÉÕÐ´³ÌÐò²¢ÔËÐÐ£¬ÈÃ¶æ»ú×ª¶¯µ½ÖÐÖµ¸½½ü£»Èç¹ûÃ»·´Ó¦ÖØ¸´1-2²½£¬»òÕßµ÷Õû¶æ»úµÄPWMÆµÂÊ¼ÆÕ¼¿Õ±È£¬ÄÜÊÜ¿ØÎª
             -×¼£»
  402            *  5.¶æ»úÊÜ¿ØºóÓÃÊÖÇá×ª£¬¶æ»ú»áÖ¨Ö¨Ïì£¬¶Ô¿¹×ª¶¯£¬´ËÊ±¿ÉÒÔ×°ÉÏ¶æÅÌ£»
  403            *  6.°´¼üK0/K1È·¶¨¶æ»úµÄ×óÓÒ×ª¶¯¼«ÏÞ£¬²¢¼ÇÏÂÀ´£¬×÷ÎªºóÐøÏÞ·ù·ÀÖ¹¶æ»ú¶Â×ªÉÕ»Ù£¡
  404           ******************************************************************************************/
  405          void Test_Servo(void)
  406          {
  407   1        char txt[36];
  408   1        u16 duty = Servo_Median;
  409   1          
  410   1        Servo_Init(Servo_FREQ);               // ¶æ»ú³õÊ¼»¯£¬ÆµÂÊÎª50Hz,ÂúÕ¼¿Õ±È20000
  411   1        Servo_Ctrl(Servo1,Servo_Median);      // ¶æ»úÖÐÖµ
  412   1        Servo_Ctrl(Servo2,Servo_Median);      // ¶æ»úÖÐÖµ
  413   1      
  414   1        OLED_Init();
  415   1        OLED_CLS();                                   // ÇåÆÁ
  416   1        OLED_P8x16Str(2, 0, "LQ Servo Test");
  417   1      
  418   1        while (1)
  419   1        {
  420   2          if (!KEY_Read(KEY0))
  421   2          {
  422   3            if (duty > 500)    // ·ÀÖ¹duty³¬
  423   3              duty -= 20;     // ±ê¶¨µÄÊ±ºò£¬¿ÉÒÔ°Ñ²½³¤¸ÄÐ¡µã£¬±ÈÈç10
  424   3          }
C251 COMPILER V5.60.0,  LQ_MotorServo                                                      18/11/25  13:45:55  PAGE 8   

  425   2          if (!KEY_Read(KEY1))
  426   2          {
  427   3            duty = Servo_Median;
  428   3          }
  429   2          if (!KEY_Read(KEY2))
  430   2          {
  431   3              if(duty<2600)
  432   3                  duty += 20;
  433   3          }
  434   2          Servo_Ctrl(Servo1,duty);           //¶æ»ú1Êä³ö
  435   2          Servo_Ctrl(Servo2,duty);           //¶æ»ú1Êä³ö
  436   2      
  437   2          sprintf(txt, "S_duty:%05d   ", duty);
  438   2          OLED_P8x16Str(1, 3, txt);   // ÏÔÊ¾
  439   2          sprintf(txt, "S_Med:%05d ", Servo_Median);//ÏÔÊ¾µ±Ç°ºê¶¨Òå¶æ»úÖÐÖµ
  440   2          OLED_P8x16Str(1, 5, txt);   // ÏÔÊ¾
  441   2          LED_Ctrl(LED0, RVS);                // LEDÉÁË¸;
  442   2          delay_ms(100);
  443   2        }
  444   1      
  445   1      }
  446          
  447          
  448          
  449          
  450          
  451          
  452          
  453          /******************************************************************************************
  454           * º¯ Êý Ãû£ºvoid BLmotor_Init(u16 freq)
  455           * ¹¦    ÄÜ£ºÎÞË¢µç»ú¿ØÖÆÒý½Å³õÊ¼»¯£¬ÆµÂÊÐèÒªºÍ¶æ»ú¿ØÖÆÆµÂÊ±£³ÖÒ»ÖÂ£¬ÍÆ¼ö50Hz
  456           * ²Î Êý Öµ£ºu16 freq£ºÎÞ¸ÐÎÞË¢PWMÊä³öµÄÆµÂÊ£¬·¶Î§40--300£¬½¨Òé50Hz
  457           * ·µ »Ø Öµ£ºÎÞ
  458           * ×÷    Õß£ºLQ008
  459           * ×îºó¸üÐÂ£º2024Äê11ÔÂ17ÈÕ
  460           * Èí¼þ°æ±¾£ºV1.0
  461           * µ÷ÓÃ¾ÙÀý£ºBLmotor_Init(50);  //³õÊ¼»¯P20 P22Òý½ÅÎªPWM£¬ÆµÂÊ50Hz,ÂúÕ¼¿Õ±È20000
  462           ******************************************************************************************/
  463          void BLmotor_Init(u16 freq)
  464          {
  465   1              PWMx_InitDefine         PWMx_InitStructure;
  466   1              /* ×¢ÒâÕâÀïµÄ¹Ü½ÅÑ¡ÔñÓëÊä³öÊ¹ÄÜ£¬PWA¾ßÓÐ»¥²¹Êä³ö¹¦ÄÜ£¬Òò´ËÓÃ²»µ½»¥²¹¹Ü½ÅÊä³ö£¬ÔòÐèÒªENOxN½ûÖ¹Êä³ö*/
  467   1          PWMA_Prescaler((MAIN_Fosc / 1000000 - 1));              //PWMÊ±ÖÓ Ô¤·ÖÆµÆ÷ÉèÖÃ PWM·ÖÆµµ½1M·¶Î§
  468   1      //    //PWM1ÉèÖÃ
  469   1      //      PWMx_InitStructure.PWM_Mode      = CCMRn_PWM_MODE1;     //Ä£Ê½, CCMRn_FREEZE,CCMRn_MATCH_VALID,CCMRn_M
             -ATCH_INVALID,CCMRn_ROLLOVER,CCMRn_FORCE_INVALID,CCMRn_FORCE_VALID,CCMRn_PWM_MODE1,CCMRn_PWM_MODE2
  470   1      //      PWMx_InitStructure.PWM_Duty      = 0;                   //PWMÕ¼¿Õ±ÈÊ±¼ä, 0~Period
  471   1      //      PWMx_InitStructure.PWM_EnoSelect = ENO1P;               //Êä³öÍ¨µÀÑ¡Ôñ, ENO1P,ENO1N,ENO2P,ENO2N,ENO3P,
             -ENO3N,ENO4P,ENO4N / ENO5P,ENO6P,ENO7P,ENO8P
  472   1      //      PWM_Configuration(PWM1, &PWMx_InitStructure);           //³õÊ¼»¯PWM1,  PWMA
  473   1      //    //PWM2ÉèÖÃ
  474   1      //      PWMx_InitStructure.PWM_Mode      = CCMRn_PWM_MODE1;     //Ä£Ê½, CCMRn_FREEZE,CCMRn_MATCH_VALID,CCMRn_M
             -ATCH_INVALID,CCMRn_ROLLOVER,CCMRn_FORCE_INVALID,CCMRn_FORCE_VALID,CCMRn_PWM_MODE1,CCMRn_PWM_MODE2
  475   1      //      PWMx_InitStructure.PWM_Duty      = 0;                   //PWMÕ¼¿Õ±ÈÊ±¼ä, 0~Period
  476   1      //      PWMx_InitStructure.PWM_EnoSelect = ENO2P;               //Êä³öÍ¨µÀÑ¡Ôñ, ENO1P,ENO1N,ENO2P,ENO2N,ENO3P,
             -ENO3N,ENO4P,ENO4N / ENO5P,ENO6P,ENO7P,ENO8P
  477   1      //      PWM_Configuration(PWM2, &PWMx_InitStructure);           //³õÊ¼»¯PWM2,  PWMA
  478   1          //PWM3ÉèÖÃ
  479   1              PWMx_InitStructure.PWM_Mode      = CCMRn_PWM_MODE1;     //Ä£Ê½, CCMRn_FREEZE,CCMRn_MATCH_VALID,CCMRn_MAT
             -CH_INVALID,CCMRn_ROLLOVER,CCMRn_FORCE_INVALID,CCMRn_FORCE_VALID,CCMRn_PWM_MODE1,CCMRn_PWM_MODE2
  480   1              PWMx_InitStructure.PWM_Duty      = 0;                   //PWMÕ¼¿Õ±ÈÊ±¼ä, 0~Period
  481   1              PWMx_InitStructure.PWM_EnoSelect = ENO3P;               //Êä³öÍ¨µÀÑ¡Ôñ, ENO1P,ENO1N,ENO2P,ENO2N,ENO3P,EN
             -O3N,ENO4P,ENO4N / ENO5P,ENO6P,ENO7P,ENO8P
  482   1              PWM_Configuration(PWM3, &PWMx_InitStructure);           //³õÊ¼»¯PWM3,  PWMA
  483   1          //PWM4ÉèÖÃ
  484   1              PWMx_InitStructure.PWM_Mode      = CCMRn_PWM_MODE1;     //Ä£Ê½, CCMRn_FREEZE,CCMRn_MATCH_VALID,CCMRn_MAT
C251 COMPILER V5.60.0,  LQ_MotorServo                                                      18/11/25  13:45:55  PAGE 9   

             -CH_INVALID,CCMRn_ROLLOVER,CCMRn_FORCE_INVALID,CCMRn_FORCE_VALID,CCMRn_PWM_MODE1,CCMRn_PWM_MODE2
  485   1              PWMx_InitStructure.PWM_Duty      = 0;                   //PWMÕ¼¿Õ±ÈÊ±¼ä, 0~Period
  486   1              PWMx_InitStructure.PWM_EnoSelect = ENO4P;               //Êä³öÍ¨µÀÑ¡Ôñ, ENO1P,ENO1N,ENO2P,ENO2N,ENO3P,EN
             -O3N,ENO4P,ENO4N / ENO5P,ENO6P,ENO7P,ENO8P
  487   1              PWM_Configuration(PWM4, &PWMx_InitStructure);           //³õÊ¼»¯PWM4,  PWMA
  488   1          //PWMA Í¨µÀ1~4ÉèÖÃ
  489   1              PWMx_InitStructure.PWM_Period        = 1000000/freq;    //ÖÜÆÚÊ±¼ä,   0~Period£¬×î¸ß¿ÉÉèÖÃ65535
  490   1              PWMx_InitStructure.PWM_DeadTime      = 0;               //ËÀÇø·¢ÉúÆ÷ÉèÖÃ, 0~255
  491   1              PWMx_InitStructure.PWM_MainOutEnable = ENABLE;          //Ö÷Êä³öÊ¹ÄÜ, ENABLE,DISABLE
  492   1              PWMx_InitStructure.PWM_CEN_Enable    = ENABLE;          //Ê¹ÄÜ¼ÆÊýÆ÷, ENABLE,DISABLE
  493   1              PWM_Configuration(PWMA, &PWMx_InitStructure);           //³õÊ¼»¯PWMÍ¨ÓÃ¼Ä´æÆ÷,  PWMA
  494   1      
  495   1          //PWMA Í¨µÀ1-4 Êä³ö¹Ü½ÅÑ¡Ôñ
  496   1      //    PWM1_USE_P10P11(); //½öÊ¹ÄÜP10Êä³ö¼´¿É£¬²»ÐèÒª»¥²¹¹Ü½ÅP11µÄÊä³ö£¬»¥²¹¹Ü½Å»¹¿É×öÆäËûÆÕÍ¨IOÊ¹ÓÃ
  497   1      //    PWM2_USE_P12P13();
  498   1          PWM3_USE_P14P15();
  499   1          PWM4_USE_P16P17();
  500   1      
  501   1          //PWMÊä³ö¹Ü½ÅÉèÖÃ£¨Æô¶¯PWM¹¦ÄÜºóÊä³ö½Å×Ô¶¯ÉèÖÃÎªÍÆÍìÊä³öÄ£Ê½ AI8051UÐèÒªÊÖ¶¯ÉèÖÃÍÆÍìÊä³ö£©
  502   1              P1_MODE_OUT_PP(GPIO_Pin_4|GPIO_Pin_6);
  503   1      
  504   1              NVIC_PWM_Init(PWMA,DISABLE,Priority_0);                     //PWMA,NVICÖÐ¶ÏÉèÖÃ
  505   1      //    UpdatePwmCh(PWM1, 5000);                       //Òª¸üÐÂµÄÍ¨µÀÒÔ¼°Õ¼¿Õ±ÈÊ±¼ä
  506   1      //    UpdatePwmCh(PWM2, 5000);
  507   1          UpdatePwmCh(PWM3, 0);                       //Òª¸üÐÂµÄÍ¨µÀÒÔ¼°Õ¼¿Õ±ÈÊ±¼ä,³õÊ¼»¯ºóÉèÎª0
  508   1          UpdatePwmCh(PWM4, 0);
  509   1      //    UpdatePwm(PWMA, &PWMA_Duty);
  510   1      }
  511          
  512          /******************************************************************************************
  513           * º¯ Êý Ãû£ºvoid BLmotor_Ctrl(u16 BLmotor1,u16 BLmotor2)
  514           * ¹¦    ÄÜ£ºBLmotor ÎÞ¸ÐÎÞË¢µçµ÷¿ØÖÆ³ÌÐò£¬µ±PWM¸ßµçÆ½Ê±¼äÔÚ1-2msÇø¼äÄÚ£¬ÎÞË¢µç»úÐý×ª£¬2msÊ±×ªËÙ×î¸ß
  515           * ²Î Êý Öµ£ºu16 BLmotor1£¬Õ¼¿Õ±È£¬·¶Î§0--10000£»
  516           * ×÷    Õß£ºLQ008
  517           * ×îºó¸üÐÂ£º2024Äê11ÔÂ17ÈÕ
  518           * Èí¼þ°æ±¾£ºV1.0
  519           * µ÷ÓÃ¾ÙÀý£ºBLmotor_Ctrl(1000£¬1000);//µ±ÆµÂÊÎª50Ê±£¬ÉèÖÃ¸ßµçÆ½Ê±¼äÎª1ms
  520           ******************************************************************************************/
  521          void BLmotor_Ctrl(u16 BLmotor1,u16 BLmotor2)
  522          {
  523   1      //  if (Sduty <= Servo_Median-1000)                  //ÏÞÖÆ·ùÖµ,¸ù¾ÝÊµ¼ÊÇé¿ö½øÐÐµ÷Õû
  524   1      //  {
  525   1      //      Sduty = Servo_Median-1000;
  526   1      //  }
  527   1      //  else if (Sduty >= Servo_Median+1000)            //ÏÞÖÆ·ùÖµ
  528   1      //  {
  529   1      //      Sduty = Servo_Median+1000;
  530   1      //  }
  531   1          UpdatePwmCh(PWM3, BLmotor1);
  532   1          UpdatePwmCh(PWM4, BLmotor2);
  533   1      }
  534          /*****************************************************************************************
  535           * º¯ Êý Ãû£ºTest_BLSmotor(void)
  536           * ¹¦    ÄÜ£ºÎÞ¸ÐÎÞË¢µç»ú²âÊÔ³ÌÐò£¬¿ØÖÆÎÞË¢µç»ú×ª¶¯
  537           * ²Î Êý Öµ£ºÎÞ
  538           * ·µ »Ø Öµ£ºÎÞ
  539           * ×÷    Õß£ºLQ008
  540           * ×îºó¸üÐÂ£º2024Äê11ÔÂ17ÈÕ
  541           * Èí¼þ°æ±¾£ºV1.0
  542           ---------------------------------------------------------------------------------------
  543           * ×¢ÒâÊÂÏî£ºÐÅºÅÏß½ÓÎÞ¸ÐÎÞË¢Çý¶¯°åºó£¬ÐèÒª½«¿ØÖÆ°åºÍÇý¶¯°å¹²µØ
  544           *  ÎÞË¢µç»ú¿ØÖÆº¯Êý,;PWM¸ßµçÆ½Ê±¼äÔÚ1-2msÄÚµç»úÐý×ª£¬
  545           *  ÓÉÓÚÎÞË¢µç»úÐý×ªÐèÒª³õËÙ¶È£¬ËùÒÔµ±duty´ïµ½³õËÙ¶Èºó£¬µç»ú¿ªÊ¼×ª¶¯
  546           *  ÉèÖÃ³õÊ¼»¯ÆµÂÊÊ±£¬ÆµÂÊÐèÒªÓë¶æ»úÆµÂÊ±£³ÖÒ»ÖÂ£¬ÍÆ¼ö50HzÆµÂÊ£¬ÂúÕ¼¿Õ±ÈÎª20000
  547           ****************************************************************************************/
  548          void Test_BLSmotor(void)
C251 COMPILER V5.60.0,  LQ_MotorServo                                                      18/11/25  13:45:55  PAGE 10  

  549          {
  550   1        char txt[20];
  551   1        u16 duty = 1000;
  552   1      
  553   1        BLmotor_Init(Servo_FREQ);         // ÆµÂÊÎª50Hz£¬´Ë´¦ÆµÂÊÐèÒªÓë¶æ»úÆµÂÊ±£³ÖÒ»ÖÂ,ÂúÕ¼¿Õ±È20000
  554   1        BLmotor_Ctrl(1000,1000);          // ÉèÖÃ³õÊ¼duty£¬¸ßµçÆ½Ê±¼äÎª1ms£¬µç»úËÙ¶ÈÎª0
  555   1      //  Servo_Init(50);                             // ¶æ»ú³õÊ¼»¯£¬ÆµÂÊÎª50Hz,ÂúÕ¼¿Õ±È20000
  556   1      //  Servo_Ctrl(Servo_Center);   // ¶æ»úÖÐÖµ
  557   1      
  558   1        OLED_Init();
  559   1        OLED_CLS();                                   // ÇåÆÁ
  560   1        OLED_P8x16Str(0, 0, "LQ BLSmotor Test");
  561   1      
  562   1        while (1)
  563   1        {
  564   2          if (!KEY_Read(KEY0))
  565   2          {
  566   3              if(duty >=900)
  567   3                  duty -= 100;
  568   3          }
  569   2          if (!KEY_Read(KEY1))
  570   2          {
  571   3              duty = 1000;
  572   3          }
  573   2          if (!KEY_Read(KEY2))
  574   2          {
  575   3              if(duty <=2000)
  576   3                  duty += 100;
  577   3          }
  578   2          BLmotor_Ctrl(duty,duty);    //ÎÞË¢µç»ú¿ØÖÆº¯Êý,;PWM¸ßµçÆ½Ê±¼äÔÚ1-2msÄÚµç»úÐý×ª£¬
  579   2                                      //ÓÉÓÚÎÞË¢µç»úÐý×ªÐèÒª³õËÙ¶È£¬ËùÒÔµ±duty´ïµ½³õËÙ¶Èºó£¬µç»ú¿ªÊ¼×ª¶¯
  580   2          sprintf(txt, "Duty:%05d ", duty);
  581   2          OLED_P8x16Str(0, 4, txt);   // ÏÔÊ¾
  582   2          LED_Ctrl(LED0, RVS);                // LEDÉÁË¸;
  583   2          delay_ms(100);
  584   2        }
  585   1      
  586   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =      1126     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =    ------         99
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =        94     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
