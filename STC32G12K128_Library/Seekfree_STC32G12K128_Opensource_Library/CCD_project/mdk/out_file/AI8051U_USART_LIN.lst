C251 COMPILER V5.60.0,  AI8051U_USART_LIN                                                  18/11/25  13:12:27  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE AI8051U_USART_LIN
OBJECT MODULE PLACED IN .\out_file\AI8051U_USART_LIN.obj
COMPILER INVOKED BY: D:\MDK\C251\BIN\C251.EXE ..\lq_libraries\Driver\Src\AI8051U_USART_LIN.c LARGE NOALIAS FLOAT64 WARNI
                    -NGLEVEL(3) OPTIMIZE(SIZE) BROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_devic
                    -e;..\..\libraries\zf_driver;..\user;..\code;..\Hardware;..\lq_libraries\LQ_LIB\Inc;..\lq_libraries\Include;..\lq_librari
                    -es\Driver\Inc) DEBUG PRINT(.\out_file\AI8051U_USART_LIN.lst) OBJECT(.\out_file\AI8051U_USART_LIN.obj) 

stmt  level    source

    1          /*---------------------------------------------------------------------*/
    2          /* --- Web: www.STCAI.com ---------------------------------------------*/
    3          /*---------------------------------------------------------------------*/
    4          
    5          #include "AI8051U_UART.h"
    6          #include "AI8051U_USART_LIN.h"
    7          
    8          //========================================================================
    9          //                               本地变量声明
   10          //========================================================================
   11          
   12          //========================================================================
   13          // 函数: void UsartLinSendByte(u8 USARTx, u8 dat)
   14          // 描述: 发送一个字节函数。
   15          // 参数: USARTx: USART组号，取值：USART1或者USART2
   16          // 参数: dat: 发送的数据.
   17          // 返回: none.
   18          // 版本: VER1.0
   19          // 日期: 2021-10-28
   20          // 备注:
   21          //========================================================================
   22          //void UsartLinSendByte(u8 USARTx, u8 dat)
   23          //{
   24          //      if(USARTx == USART1)
   25          //      {
   26          //              COM1.B_TX_busy = 1;
   27          //              SBUF = dat;
   28          //              while(COM1.B_TX_busy);
   29          //      }
   30          //      else if(USARTx == USART2)
   31          //      {
   32          //              COM2.B_TX_busy = 1;
   33          //              S2BUF = dat;
   34          //              while(COM2.B_TX_busy);
   35          //      }
   36          //}
   37          
   38          //========================================================================
   39          // 函数: void UsartLinSendData(u8 USARTx, u8 *pdat, u8 len)
   40          // 描述: Lin发送数据函数。
   41          // 参数: USARTx: USART组号，取值：USART1或者USART2
   42          // 参数: *pdat: 发生数据缓冲区
   43          // 参数: len: 数据长度.
   44          // 返回: Lin ID.
   45          // 版本: VER1.0
   46          // 日期: 2023-4-15
   47          // 备注:
   48          //========================================================================
   49          void UsartLinSendData(u8 USARTx, u8 *pdat, u8 len)
   50          {
   51   1              u8 i;
   52   1      
   53   1          if(len > 8) return;
   54   1              for(i=0;i<len;i++)
   55   1              {
   56   2                      UsartLinSendByte(USARTx,pdat[i]);
C251 COMPILER V5.60.0,  AI8051U_USART_LIN                                                  18/11/25  13:12:27  PAGE 2   

*** WARNING C140 IN LINE 56 OF ..\lq_libraries\Driver\Src\AI8051U_USART_LIN.c: 'UsartLinSendByte' undefined; assuming 'e
             -xtern int UsartLinSendByte()'
*** WARNING C95 IN LINE 56 OF ..\lq_libraries\Driver\Src\AI8051U_USART_LIN.c: 'UsartLinSendByte': too many actual parame
             -ters
*** WARNING C191 IN LINE 56 OF ..\lq_libraries\Driver\Src\AI8051U_USART_LIN.c: 'UsartLinSendByte()': potential runtime p
             -roblem with K&R parameters
   57   2              }
   58   1      }
   59          
   60          //========================================================================
   61          // 函数: void UsartLinSendChecksum(u8 USARTx, u8 *dat, u8 len)
   62          // 描述: 计算校验码并发送。
   63          // 参数: USARTx: USART组号，取值：USART1或者USART2
   64          // 参数: *dat: 数据场传输的数据
   65          // 参数: len: 数据长度.
   66          // 返回: none.
   67          // 版本: VER1.0
   68          // 日期: 2023-4-15
   69          // 备注:
   70          //========================================================================
   71          void UsartLinSendChecksum(u8 USARTx, u8 *dat, u8 len)
   72          {
   73   1          u16 sum = 0;
   74   1          u8 i;
   75   1      
   76   1          if(len > 8) return;
   77   1          for(i = 0; i < len; i++)
   78   1          {
   79   2              sum += dat[i];
   80   2              if(sum & 0xFF00)
   81   2              {
   82   3                  sum = (sum & 0x00FF) + 1;
   83   3              }
   84   2          }
   85   1          sum ^= 0x00FF;
   86   1              UsartLinSendByte(USARTx,(u8)sum);
*** WARNING C95 IN LINE 86 OF ..\lq_libraries\Driver\Src\AI8051U_USART_LIN.c: 'UsartLinSendByte': too many actual parame
             -ters
*** WARNING C191 IN LINE 86 OF ..\lq_libraries\Driver\Src\AI8051U_USART_LIN.c: 'UsartLinSendByte()': potential runtime p
             -roblem with K&R parameters
   87   1      }
   88          
   89          //========================================================================
   90          // 函数: void UsartSendBreak(u8 USARTx)
   91          // 描述: 主模式发送Lin总线Break函数。
   92          // 参数: USARTx: USART组号，取值：USART1或者USART2
   93          // 返回: none.
   94          // 版本: VER1.0
   95          // 日期: 2021-10-28
   96          // 备注:
   97          //========================================================================
   98          void UsartSendBreak(u8 USARTx)
   99          {
  100   1              if(USARTx == USART1)
  101   1              {
  102   2                      USARTCR5 |= 0x04;               //主模式 Send Break
  103   2              }
  104   1              else if(USARTx == USART2)
  105   1              {
  106   2                      USART2CR5 |= 0x04;              //主模式 Send Break
  107   2              }
  108   1              UsartLinSendByte(USARTx,0x00);
*** WARNING C95 IN LINE 108 OF ..\lq_libraries\Driver\Src\AI8051U_USART_LIN.c: 'UsartLinSendByte': too many actual param
             -eters
*** WARNING C191 IN LINE 108 OF ..\lq_libraries\Driver\Src\AI8051U_USART_LIN.c: 'UsartLinSendByte()': potential runtime 
             -problem with K&R parameters
C251 COMPILER V5.60.0,  AI8051U_USART_LIN                                                  18/11/25  13:12:27  PAGE 3   

  109   1      }
  110          
  111          //========================================================================
  112          // 函数: void UsartLinSendPID(u8 USARTx, u8 id)
  113          // 描述: ID码加上校验符，转成PID码并发送。
  114          // 参数: USARTx: USART组号，取值：USART1或者USART2
  115          // 参数: ID码.
  116          // 返回: none.
  117          // 版本: VER1.0
  118          // 日期: 2020-12-2
  119          // 备注:
  120          //========================================================================
  121          void UsartLinSendPID(u8 USARTx, u8 id)
  122          {
  123   1              u8 P0 ;
  124   1              u8 P1 ;
  125   1      
  126   1              P0 = (((id)^(id>>1)^(id>>2)^(id>>4))&0x01)<<6 ;
  127   1              P1 = ((~((id>>1)^(id>>3)^(id>>4)^(id>>5)))&0x01)<<7 ;
  128   1      
  129   1              UsartLinSendByte(USARTx,id|P0|P1);
*** WARNING C95 IN LINE 129 OF ..\lq_libraries\Driver\Src\AI8051U_USART_LIN.c: 'UsartLinSendByte': too many actual param
             -eters
*** WARNING C191 IN LINE 129 OF ..\lq_libraries\Driver\Src\AI8051U_USART_LIN.c: 'UsartLinSendByte()': potential runtime 
             -problem with K&R parameters
  130   1      }
  131          
  132          //========================================================================
  133          // 函数: void UsartLinSendHeader(u8 USARTx, u8 lid)
  134          // 描述: Lin主机发送帧头函数。
  135          // 参数: USARTx: USART组号，取值：USART1或者USART2
  136          // 参数: ID码.
  137          // 返回: none.
  138          // 版本: VER1.0
  139          // 日期: 2021-10-28
  140          // 备注:
  141          //========================================================================
  142          void UsartLinSendHeader(u8 USARTx, u8 lid)
  143          {
  144   1              UsartSendBreak(USARTx);                                         //Send Break
  145   1              UsartLinSendByte(USARTx,0x55);          //Send Sync Field
*** WARNING C95 IN LINE 145 OF ..\lq_libraries\Driver\Src\AI8051U_USART_LIN.c: 'UsartLinSendByte': too many actual param
             -eters
*** WARNING C191 IN LINE 145 OF ..\lq_libraries\Driver\Src\AI8051U_USART_LIN.c: 'UsartLinSendByte()': potential runtime 
             -problem with K&R parameters
  146   1              UsartLinSendPID(USARTx,lid);                    //设置总线ID
  147   1      }
  148          
  149          //========================================================================
  150          // 函数: void UsartLinSendFrame(u8 USARTx, u8 lid, u8 *pdat, u8 len)
  151          // 描述: Lin主机发送完整帧函数。
  152          // 参数: USARTx: USART组号，取值：USART1或者USART2
  153          // 参数: lid: Lin ID
  154          // 参数: *pdat: 发送数据缓冲区
  155          // 参数: len: 数据长度
  156          // 返回: none.
  157          // 版本: VER1.0
  158          // 日期: 2021-10-28
  159          // 备注:
  160          //========================================================================
  161          void UsartLinSendFrame(u8 USARTx, u8 lid, u8 *pdat, u8 len)
  162          {
  163   1              UsartSendBreak(USARTx);                                         //Send Break
  164   1              UsartLinSendByte(USARTx,0x55);          //Send Sync Field
*** WARNING C95 IN LINE 164 OF ..\lq_libraries\Driver\Src\AI8051U_USART_LIN.c: 'UsartLinSendByte': too many actual param
             -eters
C251 COMPILER V5.60.0,  AI8051U_USART_LIN                                                  18/11/25  13:12:27  PAGE 4   

*** WARNING C191 IN LINE 164 OF ..\lq_libraries\Driver\Src\AI8051U_USART_LIN.c: 'UsartLinSendByte()': potential runtime 
             -problem with K&R parameters
  165   1      
  166   1              UsartLinSendPID(USARTx,lid);                    //设置总线ID
  167   1              UsartLinSendData(USARTx,pdat,len);
  168   1              UsartLinSendChecksum(USARTx,pdat,len);
  169   1      }
  170          
  171          //========================================================================
  172          // 函数: void UsartLinBaudrate(u8 USARTx, u16 brt)
  173          // 描述: Lin总线波特率设置函数。
  174          // 参数: brt: 波特率.
  175          // 返回: none.
  176          // 版本: VER1.0
  177          // 日期: 2021-10-28
  178          // 备注:
  179          //========================================================================
  180          void UsartLinBaudrate(u8 USARTx, u16 brt)
  181          {
  182   1              u16 tmp;
  183   1      
  184   1              tmp = (MAIN_Fosc >> 4) / brt;
  185   1              if(USARTx == USART1)
  186   1              {
  187   2                      USARTBRH = (u8)(tmp>>8);
  188   2                      USARTBRL = (u8)tmp;
  189   2              }
  190   1              else if(USARTx == USART2)
  191   1              {
  192   2                      USART2BRH = (u8)(tmp>>8);
  193   2                      USART2BRL = (u8)tmp;
  194   2              }
  195   1      }
  196          
  197          //========================================================================
  198          // 函数: UASRT_LIN_Configuration
  199          // 描述: USART LIN初始化程序.
  200          // 参数: USARTx: UART组号, USART LIN结构参数,请参考STC32G_USART_LIN.h里的定义.
  201          // 返回: none.
  202          // 版本: V1.0, 2022-03-30
  203          //========================================================================
  204          u8 UASRT_LIN_Configuration(u8 USARTx, USARTx_LIN_InitDefine *USART)
  205          {
  206   1              if(USARTx == USART1)
  207   1              {
  208   2                      SCON = (SCON & 0x3f) | 0x40;    //USART1模式, 0x00: 同步移位输出, 0x40: 8位数据,可变波特率, 0x80: 9位数
             -据,固定波特率, 0xc0: 9位数据,可变波特率
  209   2                      SMOD = 1;
  210   2                      TI = 0;
  211   2                      REN = 1;    //允许接收
  212   2                      ES  = 1;    //允许中断
  213   2      
  214   2                      if(USART->LIN_Enable == ENABLE) USARTCR1 |= 0x80;               //使能LIN模块
  215   2                      else                                                            USARTCR1 &= ~0x80;              //关闭LIN模块
  216   2                      if(USART->LIN_Mode == LinSlaveMode)     USARTCR5 |= 0x20;               //LIN模块从机模式
  217   2                      else                                                            USARTCR5 &= ~0x20;              //LIN模块主机模式
  218   2                      if(USART->LIN_AutoSync == ENABLE)       USARTCR5 |= 0x10;               //使能自动同步
  219   2                      else                                                            USARTCR5 &= ~0x10;              //关闭自动同步
  220   2      
  221   2                      UsartLinBaudrate(USART1,USART->LIN_Baudrate);                   //设置波特率
  222   2      
  223   2                      return SUCCESS;
  224   2              }
  225   1      
  226   1              if(USARTx == USART2)
  227   1              {
C251 COMPILER V5.60.0,  AI8051U_USART_LIN                                                  18/11/25  13:12:27  PAGE 5   

  228   2                      S2CON = (S2CON & 0x3f) | 0x50;
  229   2                      T2x12 = 1;   //定时器2时钟1T模式
  230   2                      T2R = 1;     //开始计时
  231   2                      ES2 = 1;     //允许中断
  232   2                      S2CFG |= 0x80;                          //S2MOD = 1
  233   2      
  234   2                      if(USART->LIN_Enable == ENABLE) USART2CR1 |= 0x80;              //使能LIN模块
  235   2                      else                                                            USART2CR1 &= ~0x80;             //关闭LIN模块
  236   2                      if(USART->LIN_Mode == LinSlaveMode)     USART2CR5 |= 0x20;              //LIN模块从机模式
  237   2                      else                                                            USART2CR5 &= ~0x20;             //LIN模块主机模式
  238   2                      if(USART->LIN_AutoSync == ENABLE)       USART2CR5 |= 0x10;              //使能自动同步
  239   2                      else                                                            USART2CR5 &= ~0x10;             //关闭自动同步
  240   2      
  241   2                      UsartLinBaudrate(USART2,USART->LIN_Baudrate);                   //设置波特率
  242   2      
  243   2                      return SUCCESS;
  244   2              }
  245   1              return FAIL;    //错误
  246   1      }
  247          
  248          /*********************************************************/


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       767     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------          7
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  13 WARNING(S),  0 ERROR(S)
