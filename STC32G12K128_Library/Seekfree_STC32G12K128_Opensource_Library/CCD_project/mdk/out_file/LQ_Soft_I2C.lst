C251 COMPILER V5.60.0,  LQ_Soft_I2C                                                        18/11/25  13:07:51  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE LQ_Soft_I2C
OBJECT MODULE PLACED IN .\out_file\LQ_Soft_I2C.obj
COMPILER INVOKED BY: D:\MDK\C251\BIN\C251.EXE ..\lq_libraries\LQ_LIB\Src\LQ_Soft_I2C.c LARGE NOALIAS FLOAT64 WARNINGLEVE
                    -L(3) OPTIMIZE(SIZE) BROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;..\.
                    -.\libraries\zf_driver;..\user;..\code;..\Hardware;..\lq_libraries\LQ_LIB\Inc;..\lq_libraries\Include;..\lq_libraries\Dri
                    -ver\Inc) DEBUG PRINT(.\out_file\LQ_Soft_I2C.lst) OBJECT(.\out_file\LQ_Soft_I2C.obj) 

stmt  level    source

    1          /*LLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLL
    2           【平    台】北京龙邱智能科技STC32位核心板
    3           【编    写】龙邱科技
    4           【E-mail  】chiusir@163.com
    5           【软件版本】V1.0 版权所有，单位使用请先联系授权
    6           【相关信息参考下列地址】
    7           【网    站】http://www.lqist.cn
    8           【淘宝店铺】http://longqiu.taobao.com
    9           --------------------------------------------------------------------------------
   10           【  IDE  】 keil C251 V5.60
   11           【Target 】 STC32G/STC8051U/AI8051U 32位模式
   12           【SYS CLK】 42 MHz使用内部晶振
   13          QQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQ*/
   14          
   15          //#include "LQ_SOFT_I2C.h"
   16          #include "include.h"
   17          
   18          /*************************************************************************
   19           *  函数名称：IIC延时
   20           *  功能说明：ADC初始化函数
   21           *  参数说明：us      ：  延时时间
   22           *  函数返回：无
   23           *  修改时间：2020年3月10日
   24           *  应用举例：iic_delay(1);  //简单的延时
   25           *  内部调用 修改这里可以调整IIC速率
   26           *************************************************************************/
   27          void iic_delay()
   28          {
   29   1          I2C_Delay_2us(); // 延时  或者使用 delay_us(us);
   30   1      }
   31          
   32          /*************************************************************************
   33           *  函数名称：void IIC_Init(void)
   34           *  功能说明：模拟IIC初始化
   35           *  参数说明：无
   36           *  函数返回：无
   37           *  修改时间：2020年3月10日
   38           *  应用举例：IIC_Init();  //模拟IIC初始化 IIC管脚在LQ_SOFTI2C.h中定义
   39           *************************************************************************/
   40          void Soft_I2C_Init(void)
   41          {
   42   1      //    GPIO_InitTypeDef GPIO_Soft_I2C_Pin;
   43   1      //
   44   1      //    GPIO_Soft_I2C_Pin.Pin  = Soft_I2C_SCL_Pin|Soft_I2C_SDA_Pin;         //要初始化的I/O
   45   1      //    GPIO_Soft_I2C_Pin.Mode = GPIO_OUT_PP;                               //要初始化的I/O 推挽输出模式
   46   1      //    GPIO_Inilize(Soft_I2C_PORT,&GPIO_Soft_I2C_Pin);                     //初始化管脚配置
   47   1          P2_MODE_OUT_PP(Soft_I2C_SCL_Pin|Soft_I2C_SDA_Pin);      //这样初始化节省空间
   48   1      }
   49          
   50          /*************************************************************************
   51           *  函数名称：void IIC_Start(void)
   52           *  功能说明：模拟IIC起始信号
   53           *  参数说明：无
   54           *  函数返回：无
   55           *  修改时间：2020年3月10日
   56           *  应用举例：IIC_Start();
C251 COMPILER V5.60.0,  LQ_Soft_I2C                                                        18/11/25  13:07:51  PAGE 2   

   57           *************************************************************************/
   58          void IIC_Start(void)
   59          {
   60   1          SDA_OUT; // sda线输出
   61   1          IIC_SDA_H;
   62   1          IIC_SCL_H;
   63   1          iic_delay();
   64   1          iic_delay();
   65   1      
   66   1          IIC_SDA_L; // START:when CLK is high,DATA change form high to low
   67   1          iic_delay();
   68   1      
   69   1          IIC_SCL_L; // 钳住I2C总线，准备发送或接收数据
   70   1      }
   71          
   72          /*************************************************************************
   73           *  函数名称：void IIC_Stop(void)
   74           *  功能说明：模拟IIC停止信号
   75           *  参数说明：无
   76           *  函数返回：无
   77           *  修改时间：2020年3月10日
   78           *  应用举例：IIC_Stop();
   79           *************************************************************************/
   80          void IIC_Stop(void)
   81          {
   82   1          SDA_OUT; // sda线输出
   83   1          IIC_SCL_L;
   84   1          IIC_SDA_L; // STOP:when CLK is high DATA change form low to high
   85   1          iic_delay();
   86   1      
   87   1          IIC_SCL_H;
   88   1          iic_delay();
   89   1      
   90   1          IIC_SDA_H; // 发送I2C总线结束信号
   91   1          iic_delay();
   92   1      }
   93          
   94          /*************************************************************************
   95           *  函数名称：unsigned char IIC_WaitAck(void)
   96           *  功能说明：模拟IIC等待应答信号
   97           *  参数说明：无
   98           *  函数返回：1，接收应答失败    0，接收应答成功
   99           *  修改时间：2020年3月10日
  100           *  应用举例：内部调用 有效应答：从机第9个 SCL=0 时 SDA 被从机拉低,并且 SCL = 1时 SDA依然为低
  101           *************************************************************************/
  102          unsigned char IIC_WaitAck(void)
  103          {
  104   1          unsigned char ucErrTime = 0;
  105   1          SDA_IN; // SDA设置为输入  （从机给一个低电平做为应答）
  106   1          IIC_SDA_H;
  107   1          iic_delay();
  108   1          IIC_SCL_H;
  109   1          iic_delay();
  110   1          while (IIC_SDA_READ)
  111   1          {
  112   2              ucErrTime++;
  113   2              if (ucErrTime > 100)
  114   2              {
  115   3                  IIC_Stop();
  116   3                  return 1;
  117   3              }
  118   2          }
  119   1          IIC_SCL_L; // 时钟输出0
  120   1          return 0;
  121   1      }
  122          
C251 COMPILER V5.60.0,  LQ_Soft_I2C                                                        18/11/25  13:07:51  PAGE 3   

  123          /*************************************************************************
  124           *  函数名称：void IIC_Ack(void)
  125           *  功能说明：模拟IIC产生ACK应答
  126           *  参数说明：无
  127           *  函数返回：无
  128           *  修改时间：2020年3月10日
  129           *  应用举例：内部调用 主机接收完一个字节数据后，主机产生的ACK通知从机一个字节数据已正确接收
  130           *************************************************************************/
  131          void IIC_Ack(void)
  132          {
  133   1          IIC_SCL_L;
  134   1          SDA_OUT;
  135   1          IIC_SDA_L;
  136   1          iic_delay();
  137   1      
  138   1          IIC_SCL_H;
  139   1          iic_delay();
  140   1      
  141   1          IIC_SCL_L;
  142   1      }
  143          
  144          /*************************************************************************
  145           *  函数名称：void IIC_NAck(void)
  146           *  功能说明：模拟IIC不产生ACK应答
  147           *  参数说明：无
  148           *  函数返回：无
  149           *  修改时间：2020年3月10日
  150           *  应用举例：内部调用 主机接收完最后一个字节数据后，主机产生的NACK通知从机发送结束，释放SDA,以便主机产生
             -停止信号
  151           *************************************************************************/
  152          void IIC_NAck(void)
  153          {
  154   1          IIC_SCL_L;
  155   1          SDA_OUT;
  156   1          IIC_SDA_H;
  157   1          iic_delay();
  158   1      
  159   1          IIC_SCL_H;
  160   1          iic_delay();
  161   1      
  162   1          IIC_SCL_L;
  163   1      }
  164          
  165          /*************************************************************************
  166           *  函数名称：void IIC_SendByte(unsigned char data_t)
  167           *  功能说明：模拟IIC发送一个字节
  168           *  参数说明：data   :  发送的字节
  169           *  函数返回：无
  170           *  修改时间：2020年3月10日
  171           *  应用举例：IIC_SendByte(0x12);
  172           *************************************************************************/
  173          void IIC_SendByte(unsigned char data_t)
  174          {
  175   1          unsigned char t;
  176   1          SDA_OUT;
  177   1          IIC_SCL_L; // 拉低时钟开始数据传输
  178   1          for (t = 0; t < 8; t++)
  179   1          {
  180   2              //        IIC_SDA_READ = data_t&0x80;
  181   2              if (data_t & 0x80)
  182   2              {
  183   3                  IIC_SDA_H;
  184   3              }
  185   2              else
  186   2              {
  187   3                  IIC_SDA_L;
C251 COMPILER V5.60.0,  LQ_Soft_I2C                                                        18/11/25  13:07:51  PAGE 4   

  188   3              }
  189   2      
  190   2              IIC_SCL_H;
  191   2              ;
  192   2              iic_delay();
  193   2              data_t <<= 1;
  194   2              iic_delay();
  195   2      
  196   2              IIC_SCL_L;
  197   2              iic_delay();
  198   2          }
  199   1          iic_delay();
  200   1      }
  201          
  202          /*************************************************************************
  203           *  函数名称：unsigned char IIC_ReadByte(unsigned char ack)
  204           *  功能说明：模拟IIC读取一个字节
  205           *  参数说明：ack=1 时，主机数据还没接收完 ack=0 时主机数据已全部接收完成
  206           *  函数返回：接收到的字节
  207           *  修改时间：2020年3月10日
  208           *  应用举例：IC_ReadByte(0x12);
  209           *************************************************************************/
  210          unsigned char IIC_ReadByte(unsigned char ack)
  211          {
  212   1          unsigned char i, receive = 0;
  213   1          SDA_IN; // SDA设置为输入模式 等待接收从机返回数据
  214   1          for (i = 0; i < 8; i++)
  215   1          {
  216   2              IIC_SCL_L;
  217   2              iic_delay();
  218   2      
  219   2              IIC_SCL_H;
  220   2              receive <<= 1;
  221   2              if (IIC_SDA_READ)
  222   2                  receive++; // 从机发送的电平
  223   2              iic_delay();
  224   2          }
  225   1          if (ack)
  226   1              IIC_Ack(); // 发送ACK
  227   1          else
  228   1              IIC_NAck(); // 发送nACK
  229   1          return receive;
  230   1      }
  231          
  232          /*************************************************************************
  233           *  函数名称：void ADC_init(void)
  234           *  功能说明：模拟IIC读取指定设备 指定寄存器的一个值
  235           *  参数说明：
  236           * @param    I2C_Addr  目标设备地址
  237           * @param    reg       目标寄存器
  238           * @param    buf       存放读出字节
  239           *  函数返回：1失败 0成功
  240           *  修改时间：2020年3月10日
  241           *  应用举例：IIC_ReadByteFromSlave(0xD0, 0x75, &data);   //读 IIC地址为 0xD0器件（MPU6050）寄存器0x75
  242           *************************************************************************/
  243          unsigned char IIC_ReadByteFromSlave(unsigned char I2C_Addr, unsigned char reg, unsigned char *buf)
  244          {
  245   1          IIC_Start();
  246   1          IIC_SendByte(I2C_Addr); // 发送从机地址
  247   1          if (IIC_WaitAck())      // 如果从机未应答则数据发送失败
  248   1          {
  249   2              IIC_Stop();
  250   2              return 1;
  251   2          }
  252   1          IIC_SendByte(reg); // 发送寄存器地址
  253   1          IIC_WaitAck();
C251 COMPILER V5.60.0,  LQ_Soft_I2C                                                        18/11/25  13:07:51  PAGE 5   

  254   1      
  255   1          IIC_Start();
  256   1          I2C_Addr = I2C_Addr + 1;
  257   1          IIC_SendByte(I2C_Addr); // 进入接收模式
  258   1          IIC_WaitAck();
  259   1          *buf = IIC_ReadByte(0);
  260   1          IIC_Stop(); // 产生一个停止条件
  261   1          return 0;
  262   1      }
  263          
  264          /*************************************************************************
  265           *  函数名称：void ADC_init(void)
  266           *  功能说明：模拟IIC写指定设备 指定寄存器的一个值
  267           *  参数说明：
  268           * @param    I2C_Addr  目标设备地址
  269           * @param    reg       目标寄存器
  270           * @param    data      写入的数据
  271           *  函数返回：1失败 0成功
  272           *  修改时间：2020年3月10日
  273           *  应用举例：IIC_ReadByteFromSlave(0xD0, 0X6B, 0X80);   //IIC地址为 0xD0器件（MPU6050）寄存器0x6B 写入0x
             -80
  274           *************************************************************************/
  275          unsigned char IIC_WriteByteToSlave(unsigned char I2C_Addr, unsigned char reg, unsigned char data_t)
  276          {
  277   1          IIC_Start();
  278   1          IIC_SendByte(I2C_Addr); // 发送从机地址
  279   1          if (IIC_WaitAck())
  280   1          {
  281   2              IIC_Stop();
  282   2              return 1; // 从机地址写入失败
  283   2          }
  284   1          IIC_SendByte(reg); // 发送寄存器地址
  285   1          IIC_WaitAck();
  286   1          IIC_SendByte(data_t);
  287   1          if (IIC_WaitAck())
  288   1          {
  289   2              IIC_Stop();
  290   2              return 1; // 数据写入失败
  291   2          }
  292   1          IIC_Stop(); // 产生一个停止条件
  293   1      
  294   1          // return 1; //status == 0;
  295   1          return 0;
  296   1      }
  297          
  298          /*************************************************************************
  299           *  函数名称：unsigned char IIC_ReadMultByteFromSlave(unsigned char dev, unsigned char reg, unsigned char
             - length, unsigned char *data_t)
  300           *  功能说明：模拟IIC读取指定设备 指定寄存器的n个值
  301           *  参数说明：
  302           * @param    dev       目标设备地址
  303           * @param    reg       目标寄存器
  304           * @param    length    读取长度
  305           * @param    data      存放读出数据
  306           *  函数返回：1失败 0成功
  307           *  修改时间：2020年3月10日
  308           *  应用举例：IIC_ReadByteFromSlave(0xD0, 0X3B, 14, &data);   //读 14个字节
  309           *************************************************************************/
  310          unsigned char IIC_ReadMultByteFromSlave(unsigned char dev, unsigned char reg, unsigned char length, unsig
             -ned char *data_t)
  311          {
  312   1          unsigned char count = 0;
  313   1          unsigned char temp;
  314   1          IIC_Start();
  315   1          IIC_SendByte(dev); // 发送从机地址
  316   1          if (IIC_WaitAck())
C251 COMPILER V5.60.0,  LQ_Soft_I2C                                                        18/11/25  13:07:51  PAGE 6   

  317   1          {
  318   2              IIC_Stop();
  319   2              return 1; // 从机地址写入失败
  320   2          }
  321   1          IIC_SendByte(reg); // 发送寄存器地址
  322   1          IIC_WaitAck();
  323   1          IIC_Start();
  324   1          dev = dev + 1;
  325   1          IIC_SendByte(dev); // 进入接收模式
  326   1          IIC_WaitAck();
  327   1          for (count = 0; count < length; count++)
  328   1          {
  329   2              if (count != (length - 1))
  330   2                  temp = IIC_ReadByte(1); // 带ACK的读数据
  331   2              else
  332   2                  temp = IIC_ReadByte(0); // 最后一个字节NACK
  333   2      
  334   2              data_t[count] = temp;
  335   2          }
  336   1          IIC_Stop(); // 产生一个停止条件
  337   1          // return count;
  338   1          return 0;
  339   1      }
  340          
  341          /*************************************************************************
  342           *  函数名称：unsigned char IIC_WriteMultByteToSlave(unsigned char dev, unsigned char reg, unsigned char 
             -length, unsigned char* data_t)
  343           *  功能说明：模拟IIC写指定设备 指定寄存器的n个值
  344           *  参数说明：
  345           * @param    dev       目标设备地址
  346           * @param    reg       目标寄存器
  347           * @param    length    写入长度
  348           * @param    data      存放写入数据
  349           *  函数返回： 1失败 0成功
  350           *  修改时间：2020年3月10日
  351           *  应用举例：IIC_WriteMultByteToSlave(0xD0, 0X6B, 1, 0X80);   //向寄存器0x6B写入0x80
  352           *************************************************************************/
  353          unsigned char IIC_WriteMultByteToSlave(unsigned char dev, unsigned char reg, unsigned char length, unsign
             -ed char *data_t)
  354          {
  355   1      
  356   1          unsigned char count = 0;
  357   1          IIC_Start();
  358   1          IIC_SendByte(dev); // 发送从机地址
  359   1          if (IIC_WaitAck())
  360   1          {
  361   2              IIC_Stop();
  362   2              return 1; // 从机地址写入失败
  363   2          }
  364   1          IIC_SendByte(reg); // 发送寄存器地址
  365   1          IIC_WaitAck();
  366   1          for (count = 0; count < length; count++)
  367   1          {
  368   2              IIC_SendByte(data_t[count]);
  369   2              if (IIC_WaitAck()) // 每一个字节都要等从机应答
  370   2              {
  371   3                  IIC_Stop();
  372   3                  return 1; // 数据写入失败
  373   3              }
  374   2          }
  375   1          IIC_Stop(); // 产生一个停止条件
  376   1      
  377   1          return 0;
  378   1      }
  379          /*LLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLL
  380          【函数名】 int LQ_I2C_Write(unsigned char addr, unsigned char reg, unsigned int len, unsigned char *dat)
C251 COMPILER V5.60.0,  LQ_Soft_I2C                                                        18/11/25  13:07:51  PAGE 7   

  381          【功  能】 模拟SPI读写数据及长度
  382          * @param    addr   标设备地址
  383          * @param    reg    目标寄存器
  384          * @param    len    写入长度
  385          * @param    *dat   存放写入数据
  386          【返回值】 1失败 0成功
  387          【作  者】 L Q
  388          【最后更新】 2021年4月3日
  389          【软件版本】 V1.1
  390          【调用样例】 LQ_I2C_Write(0x68, 0x38, 1, tmp)
  391          QQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQ*/
  392          int LQ_I2C_Write(unsigned char addr, unsigned char reg, unsigned int len, unsigned char *dat)
  393          {
  394   1          unsigned int i = 0;
  395   1      
  396   1          IIC_Start();
  397   1          IIC_SendByte(addr << 1);
  398   1          IIC_WaitAck();
  399   1      
  400   1          IIC_SendByte(reg);
  401   1          IIC_WaitAck();
  402   1      
  403   1          for (i = 0; i < len; i++)
  404   1          {
  405   2              IIC_SendByte(dat[i]);
  406   2              IIC_WaitAck();
  407   2          }
  408   1          IIC_Stop();
  409   1          return 0;
  410   1      }
  411          
  412          /*LLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLLL
  413          【函数名】 int LQ_I2C_Read(unsigned char addr, unsigned char reg, unsigned int len, unsigned char *buf)
  414          【功  能】 模拟SPI读写数据及长度
  415          * @param    addr   标设备地址
  416          * @param    reg    目标寄存器
  417          * @param    len    读取长度
  418          * @param    *buf   存放读取数据
  419          【返回值】 1失败 0成功
  420          【作  者】 L Q
  421          【最后更新】 2021年4月3日
  422          【软件版本】 V1.1
  423          【调用样例】 LQ_I2C_Write(0x68, 0x38, 1, tmp)
  424          QQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQQ*/
  425          int LQ_I2C_Read(unsigned char addr, unsigned char reg, unsigned int len, unsigned char *buf)
  426          {
  427   1          IIC_Start();
  428   1          IIC_SendByte(addr << 1);
  429   1          IIC_WaitAck();
  430   1      
  431   1          IIC_SendByte(reg);
  432   1          IIC_WaitAck();
  433   1          iic_delay();
  434   1          IIC_Start();
  435   1          addr = (addr << 1) + 1;
  436   1          IIC_SendByte(addr);
  437   1          IIC_WaitAck();
  438   1          while (len)
  439   1          {
  440   2              if (len == 1)
  441   2                  *buf = IIC_ReadByte(0);
  442   2              else
  443   2                  *buf = IIC_ReadByte(1);
  444   2              buf++;
  445   2              len--;
  446   2          }
C251 COMPILER V5.60.0,  LQ_Soft_I2C                                                        18/11/25  13:07:51  PAGE 8   

  447   1          IIC_Stop();
  448   1          return 0;
  449   1      }


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       917     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------         23
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
