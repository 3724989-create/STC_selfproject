C251 COMPILER V5.60.0,  AI8051U_LIN                                                        18/11/25  13:07:44  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE AI8051U_LIN
OBJECT MODULE PLACED IN .\out_file\AI8051U_LIN.obj
COMPILER INVOKED BY: D:\MDK\C251\BIN\C251.EXE ..\lq_libraries\Driver\Src\AI8051U_LIN.c LARGE NOALIAS FLOAT64 WARNINGLEVE
                    -L(3) OPTIMIZE(SIZE) BROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;..\.
                    -.\libraries\zf_driver;..\user;..\code;..\Hardware;..\lq_libraries\LQ_LIB\Inc;..\lq_libraries\Include;..\lq_libraries\Dri
                    -ver\Inc) DEBUG PRINT(.\out_file\AI8051U_LIN.lst) OBJECT(.\out_file\AI8051U_LIN.obj) 

stmt  level    source

    1          /*---------------------------------------------------------------------*/
    2          /* ------------------- Web: www.STCAI.com -----------------------------*/
    3          /*---------------------------------------------------------------------*/
    4          
    5          #include "AI8051U_LIN.h"
    6          
    7          //========================================================================
    8          // 函数: u8 ReadReg(u8 addr)
    9          // 描述: Lin功能寄存器读取函数。
   10          // 参数: Lin功能寄存器地址.
   11          // 返回: Lin功能寄存器数据.
   12          // 版本: VER1.0
   13          // 日期: 2021-01-05
   14          // 备注:
   15          //========================================================================
   16          u8 LinReadReg(u8 addr)
   17          {
   18   1              u8 dat;
   19   1              LINAR = addr;
   20   1              dat = LINDR;
   21   1              return dat;
   22   1      }
   23          
   24          //========================================================================
   25          // 函数: void WriteReg(u8 addr, u8 dat)
   26          // 描述: Lin功能寄存器配置函数。
   27          // 参数: Lin功能寄存器地址, Lin功能寄存器数据.
   28          // 返回: none.
   29          // 版本: VER1.0
   30          // 日期: 2021-01-05
   31          // 备注:
   32          //========================================================================
   33          void LinWriteReg(u8 addr, u8 dat)
   34          {
   35   1              LINAR = addr;
   36   1              LINDR = dat;
   37   1      }
   38          
   39          //========================================================================
   40          // 函数: void LinReadMsg(u8 *pdat)
   41          // 描述: Lin读取数据函数。
   42          // 参数: *pdat: 接收数据缓冲区.
   43          // 返回: none.
   44          // 版本: VER1.0
   45          // 日期: 2021-01-05
   46          // 备注:
   47          //========================================================================
   48          void LinReadMsg(u8 *pdat)
   49          {
   50   1              u8 i;
   51   1      
   52   1              LinWriteReg(LSEL, 0x80); // 地址自增，从0开始
   53   1              for (i = 0; i < FRAME_LEN; i++)
   54   1              {
   55   2                      pdat[i] = LinReadReg(LBUF);
   56   2              }
C251 COMPILER V5.60.0,  AI8051U_LIN                                                        18/11/25  13:07:44  PAGE 2   

   57   1      }
   58          
   59          //========================================================================
   60          // 函数: void LinSendMsg(u8 *pdat)
   61          // 描述: Lin设置数据函数。
   62          // 参数: *pdat: 设置数据缓冲区.
   63          // 返回: Lin ID.
   64          // 版本: VER1.0
   65          // 日期: 2021-01-05
   66          // 备注:
   67          //========================================================================
   68          void LinSendMsg(u8 *pdat)
   69          {
   70   1              u8 i;
   71   1      
   72   1              LinWriteReg(LSEL, 0x80); // 地址自增，从0开始
   73   1              for (i = 0; i < FRAME_LEN; i++)
   74   1              {
   75   2                      LinWriteReg(LBUF, pdat[i]);
   76   2              }
   77   1      }
   78          
   79          //========================================================================
   80          // 函数: void LinSetID(u8 lid)
   81          // 描述: 设置LIN ID函数。
   82          // 参数: none.
   83          // 返回: none.
   84          // 版本: VER1.0
   85          // 日期: 2021-01-05
   86          // 备注:
   87          //========================================================================
   88          void LinSetID(u8 lid)
   89          {
   90   1              LinWriteReg(LID, lid); // 设置总线ID
   91   1      }
   92          
   93          //========================================================================
   94          // 函数: u8 GetLinError(void)
   95          // 描述: 获取LIN总线错误寄存器状态。
   96          // 参数: none.
   97          // 返回: 错误寄存器状态.
   98          // 版本: VER1.0
   99          // 日期: 2021-01-05
  100          // 备注:
  101          //========================================================================
  102          u8 GetLinError(void)
  103          {
  104   1              u8 sta;
  105   1              sta = LinReadReg(LER); // 读取清除错误寄存器
  106   1              return sta;
  107   1      }
  108          
  109          //========================================================================
  110          // 函数: u8 WaitLinReady(void)
  111          // 描述: 等待LIN总线就绪。
  112          // 参数: none.
  113          // 返回: LIN总线状态.
  114          // 版本: VER1.0
  115          // 日期: 2021-01-05
  116          // 备注:
  117          //========================================================================
  118          u8 WaitLinReady(void)
  119          {
  120   1              u8 lsr;
  121   1              do
  122   1              {
C251 COMPILER V5.60.0,  AI8051U_LIN                                                        18/11/25  13:07:44  PAGE 3   

  123   2                      lsr = LinReadReg(LSR);
  124   2              } while (!(lsr & 0x02)); // 判断ready状态
  125   1              return lsr;
  126   1      }
  127          
  128          //========================================================================
  129          // 函数: void SendAbortCmd(void)
  130          // 描述: 主模式发送Lin总线Abort函数。
  131          // 参数: none.
  132          // 返回: none.
  133          // 版本: VER1.0
  134          // 日期: 2021-01-05
  135          // 备注:
  136          //========================================================================
  137          void SendAbortCmd(void)
  138          {
  139   1              LinWriteReg(LCR, 0x80); // 主模式 Send Abort
  140   1      }
  141          
  142          //========================================================================
  143          // 函数: void SendHeadCmd(void)
  144          // 描述: 主模式发送Lin总线Header函数。
  145          // 参数: none.
  146          // 返回: none.
  147          // 版本: VER1.0
  148          // 日期: 2021-01-05
  149          // 备注:
  150          //========================================================================
  151          void SendHeadCmd(void)
  152          {
  153   1              LinWriteReg(LCR, 0x81); // 主模式 Send Header
  154   1      }
  155          
  156          //========================================================================
  157          // 函数: void SendDatCmd(void)
  158          // 描述: 主模式发送Lin总线数据函数。
  159          // 参数: none.
  160          // 返回: none.
  161          // 版本: VER1.0
  162          // 日期: 2021-01-05
  163          // 备注:
  164          //========================================================================
  165          void SendDatCmd(void)
  166          {
  167   1              u8 lcr_val;
  168   1              lcr_val = 0x82 + (LIN_MODE << 6) + (FRAME_LEN << 2);
  169   1              LinWriteReg(LCR, lcr_val);
  170   1      }
  171          
  172          //========================================================================
  173          // 函数: void ResponseTxCmd(void)
  174          // 描述: 从模式发送Lin总线Tx Response函数。
  175          // 参数: none.
  176          // 返回: none.
  177          // 版本: VER1.0
  178          // 日期: 2021-01-05
  179          // 备注:
  180          //========================================================================
  181          void ResponseTxCmd(void)
  182          {
  183   1              u8 lcr_val;
  184   1              lcr_val = 0x02 + (LIN_MODE << 6) + (FRAME_LEN << 2);
  185   1              LinWriteReg(LCR, lcr_val);
  186   1      }
  187          
  188          //========================================================================
C251 COMPILER V5.60.0,  AI8051U_LIN                                                        18/11/25  13:07:44  PAGE 4   

  189          // 函数: void ResponseRxCmd(void)
  190          // 描述: 从模式发送Lin总线Rx Response函数。
  191          // 参数: none.
  192          // 返回: none.
  193          // 版本: VER1.0
  194          // 日期: 2021-01-05
  195          // 备注:
  196          //========================================================================
  197          void ResponseRxCmd(void)
  198          {
  199   1              u8 lcr_val;
  200   1              lcr_val = 0x03 + (LIN_MODE << 6) + (FRAME_LEN << 2);
  201   1              LinWriteReg(LCR, lcr_val);
  202   1      }
  203          
  204          //========================================================================
  205          // 函数: void LinTxResponse(u8 *pdat)
  206          // 描述: Lin从机发送应答数据，跟主机发送的Header拼成一个完整的帧。
  207          // 参数: *pdat: 发送数据缓冲区.
  208          // 返回: none.
  209          // 版本: VER1.0
  210          // 日期: 2021-01-05
  211          // 备注:
  212          //========================================================================
  213          void LinTxResponse(u8 *pdat)
  214          {
  215   1              LinSendMsg(pdat);
  216   1              ResponseTxCmd(); // TX response
  217   1              WaitLinReady();  // 等待ready状态
  218   1              GetLinError();   // 读取清除错误寄存器
  219   1      }
  220          
  221          //========================================================================
  222          // 函数: void LinReadFrame(u8 *pdat)
  223          // 描述: Lin主机发送完整帧函数。
  224          // 参数: lid: Lin ID; *pdat: 发送数据缓冲区.
  225          // 返回: none.
  226          // 版本: VER1.0
  227          // 日期: 2021-01-05
  228          // 备注:
  229          //========================================================================
  230          void LinReadFrame(u8 *pdat)
  231          {
  232   1              ResponseRxCmd(); // RX response
  233   1              WaitLinReady();  // 等待ready状态
  234   1              GetLinError();   // 读取清除错误寄存器
  235   1      
  236   1              LinReadMsg(pdat); // 接收Lin总线数据
  237   1      }
  238          
  239          //========================================================================
  240          // 函数: void LinSendFrame(u8 lid, u8 *pdat)
  241          // 描述: Lin主机发送完整帧函数。
  242          // 参数: lid: Lin ID; *pdat: 发送数据缓冲区.
  243          // 返回: none.
  244          // 版本: VER1.0
  245          // 日期: 2021-01-05
  246          // 备注:
  247          //========================================================================
  248          void LinSendFrame(u8 lid, u8 *pdat)
  249          {
  250   1              LinSetID(lid); // 设置总线ID
  251   1              LinSendMsg(pdat);
  252   1      
  253   1              SendHeadCmd();  // 主模式 Send Seader
  254   1              WaitLinReady(); // 等待ready状态
C251 COMPILER V5.60.0,  AI8051U_LIN                                                        18/11/25  13:07:44  PAGE 5   

  255   1              GetLinError();  // 读取清除错误寄存器
  256   1      
  257   1              SendDatCmd();   // Send Data
  258   1              WaitLinReady(); // 等待ready状态
  259   1              GetLinError();  // 读取清除错误寄存器
  260   1      }
  261          
  262          //========================================================================
  263          // 函数: void LinSendHeaderRead(u8 lid, u8 *pdat)
  264          // 描述: Lin主机发送Header，由从机发送应答数据，拼成一个完整的帧。
  265          // 参数: lid: 发送应答从机的总线ID; *pdat: 接收数据缓冲区.
  266          // 返回: none.
  267          // 版本: VER1.0
  268          // 日期: 2021-01-05
  269          // 备注:
  270          //========================================================================
  271          void LinSendHeaderRead(u8 lid, u8 *pdat)
  272          {
  273   1              LinSetID(lid); // 设置发送Response从机总线ID
  274   1      
  275   1              SendHeadCmd();  // 主模式 send header
  276   1              WaitLinReady(); // 等待ready状态
  277   1              GetLinError();  // 读取清除错误寄存器
  278   1      
  279   1              ResponseRxCmd(); // RX response
  280   1              WaitLinReady();  // 等待ready状态
  281   1              GetLinError();   // 读取清除错误寄存器
  282   1      
  283   1              LinReadMsg(pdat); // 接收Lin总线从机发送的应答数据
  284   1      }
  285          
  286          //========================================================================
  287          // 函数: void LinSetBaudrate(u16 brt)
  288          // 描述: Lin总线波特率设置函数。
  289          // 参数: brt: 波特率.
  290          // 返回: none.
  291          // 版本: VER1.0
  292          // 日期: 2021-01-05
  293          // 备注:
  294          //========================================================================
  295          void LinSetBaudrate(u16 brt)
  296          {
  297   1              u16 tmp;
  298   1              tmp = (MAIN_Fosc >> 4) / brt;
  299   1              LinWriteReg(DLH, (u8)(tmp >> 8));
  300   1              LinWriteReg(DLL, (u8)tmp);
  301   1      }
  302          
  303          //========================================================================
  304          // 函数: void LinSetHeadDelay(u8 base_ms, u8 prescaler)
  305          // 描述: Lin总线设置帧头延时函数。
  306          // 参数: base_ms:延时计数, prescaler:延时分频.
  307          // 返回: none.
  308          // 版本: VER1.0
  309          // 日期: 2021-01-05
  310          // 备注:
  311          //========================================================================
  312          void LinSetHeadDelay(u8 base_ms, u8 prescaler)
  313          {
  314   1              u16 tmp;
  315   1              tmp = (MAIN_Fosc * base_ms) / 1000;
  316   1              LinWriteReg(HDRH, (u8)(tmp >> 8));
  317   1              LinWriteReg(HDRL, (u8)tmp); // 设置帧头延时计数
  318   1      
  319   1              LinWriteReg(HDP, prescaler); // 设置帧头延时分频
  320   1      }
C251 COMPILER V5.60.0,  AI8051U_LIN                                                        18/11/25  13:07:44  PAGE 6   

  321          
  322          //========================================================================
  323          // 函数: void LIN_Inilize(LIN_InitTypeDef *LIN)
  324          // 描述: LIN 初始化程序.
  325          // 参数: LIN: 结构参数,请参考LIN.h里的定义.
  326          // 返回: none.
  327          // 版本: V1.0, 2021-06-02
  328          //========================================================================
  329          void LIN_Inilize(LIN_InitTypeDef *LIN)
  330          {
  331   1              if (LIN->LIN_Enable == ENABLE)
  332   1                      LINEN = 1; // 使能LIN模块
  333   1              else
  334   1                      LINEN = 0; // 关闭LIN模块
  335   1      
  336   1              GetLinError();                                                                                           // 读取清除错误寄存器
  337   1              LinWriteReg(LIE, LIN->LIN_IE);                                                           // LIE中断使能寄存器
  338   1              LinSetBaudrate(LIN->LIN_Baudrate);                                                       // 设置波特率
  339   1              LinSetHeadDelay(LIN->LIN_HeadDelay, LIN->LIN_HeadPrescaler); // 设置帧头延时
  340   1      }
*** WARNING C183 IN LINE 168 OF ..\lq_libraries\Driver\Src\AI8051U_LIN.c: dead assignment eliminated
*** WARNING C183 IN LINE 184 OF ..\lq_libraries\Driver\Src\AI8051U_LIN.c: dead assignment eliminated
*** WARNING C183 IN LINE 200 OF ..\lq_libraries\Driver\Src\AI8051U_LIN.c: dead assignment eliminated


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       420     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------          2
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =    ------     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  3 WARNING(S),  0 ERROR(S)
