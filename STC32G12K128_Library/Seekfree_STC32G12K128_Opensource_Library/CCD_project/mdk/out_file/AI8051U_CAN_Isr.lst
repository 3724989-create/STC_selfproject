C251 COMPILER V5.60.0,  AI8051U_CAN_Isr                                                    18/11/25  13:07:41  PAGE 1   


C251 COMPILER V5.60.0, COMPILATION OF MODULE AI8051U_CAN_Isr
OBJECT MODULE PLACED IN .\out_file\AI8051U_CAN_Isr.obj
COMPILER INVOKED BY: D:\MDK\C251\BIN\C251.EXE ..\lq_libraries\Driver\isr\AI8051U_CAN_Isr.c LARGE NOALIAS FLOAT64 WARNING
                    -LEVEL(3) OPTIMIZE(SIZE) BROWSE INCDIR(..\..\libraries\zf_common;..\..\libraries\zf_components;..\..\libraries\zf_device;
                    -..\..\libraries\zf_driver;..\user;..\code;..\Hardware;..\lq_libraries\LQ_LIB\Inc;..\lq_libraries\Include;..\lq_libraries
                    -\Driver\Inc) DEBUG PRINT(.\out_file\AI8051U_CAN_Isr.lst) OBJECT(.\out_file\AI8051U_CAN_Isr.obj) 

stmt  level    source

    1          /*---------------------------------------------------------------------*/
    2          /* ------------------- Web: www.STCAI.com -----------------------------*/
    3          /*---------------------------------------------------------------------*/
    4          
    5          #include        "AI8051U_CAN.h"
    6          
    7          bit B_Can1Send;     //CAN1 发送完成标志
    8          bit B_Can2Send;     //CAN2 发送完成标志
    9          bit B_Can1Read;     //CAN1 收到数据标志
   10          bit B_Can2Read;     //CAN2 收到数据标志
   11          
   12          //========================================================================
   13          // 函数: CAN1_ISR_Handler
   14          // 描述: CAN1中断函数.
   15          // 参数: none.
   16          // 返回: none.
   17          // 版本: V1.0, 2022-03-27
   18          //========================================================================
   19          void CAN1_ISR_Handler (void) interrupt CAN1_VECTOR
   20          {
   21   1              u8 isr;
   22   1              u8 store;
   23   1              u8 arTemp;
   24   1      
   25   1              arTemp = CANAR;     //先CANAR现场保存，避免主循环里写完 CANAR 后产生中断，在中断里修改了 CANAR 内容
   26   1              store = AUXR2;      //后AUXR2现场保存
   27   1      
   28   1              AUXR2 &= ~0x08;         //选择CAN1模块
   29   1              isr = CanReadReg(ISR);
   30   1      
   31   1              if((isr & 0x04) == 0x04)  //TI
   32   1              {
   33   2                      CANAR = ISR;
   34   2                      CANDR = 0x04;    //CLR FLAG
   35   2      
   36   2              B_Can1Send = 0;
   37   2        }
   38   1              if((isr & 0x08) == 0x08)  //RI
   39   1              {
   40   2                      CANAR = ISR;
   41   2                      CANDR = 0x08;    //CLR FLAG
   42   2      
   43   2                      B_Can1Read = 1;
   44   2              }
   45   1      
   46   1              if((isr & 0x40) == 0x40)  //ALI
   47   1              {
   48   2                      CANAR = ISR;
   49   2                      CANDR = 0x40;    //CLR FLAG
   50   2              }
   51   1      
   52   1              if((isr & 0x20) == 0x20)  //EWI
   53   1              {
   54   2                      CANAR = MR;
   55   2                      CANDR &= ~0x04;  //清除 Reset Mode, 从BUS-OFF状态退出
   56   2      
C251 COMPILER V5.60.0,  AI8051U_CAN_Isr                                                    18/11/25  13:07:41  PAGE 2   

   57   2                      CANAR = ISR;
   58   2                      CANDR = 0x20;    //CLR FLAG
   59   2              }
   60   1      
   61   1              if((isr & 0x10) == 0x10)  //EPI
   62   1              {
   63   2                      CANAR = ISR;
   64   2                      CANDR = 0x10;    //CLR FLAG
   65   2              }
   66   1      
   67   1              if((isr & 0x02) == 0x02)  //BEI
   68   1              {
   69   2                      CANAR = ISR;
   70   2                      CANDR = 0x02;    //CLR FLAG
   71   2              }
   72   1      
   73   1              if((isr & 0x01) == 0x01)  //DOI
   74   1              {
   75   2                      CANAR = ISR;
   76   2                      CANDR = 0x01;    //CLR FLAG
   77   2              }
   78   1      
   79   1              AUXR2 = store;     //先AUXR2现场恢复
   80   1              CANAR = arTemp;    //后CANAR现场恢复
   81   1      }
   82          
   83          //========================================================================
   84          // 函数: CAN2_ISR_Handler
   85          // 描述: CAN2中断函数.
   86          // 参数: none.
   87          // 返回: none.
   88          // 版本: V1.0, 2022-03-27
   89          //========================================================================
   90          void CAN2_ISR_Handler (void) interrupt CAN2_VECTOR
   91          {
   92   1              u8 isr;
   93   1              u8 store;
   94   1              u8 arTemp;
   95   1      
   96   1              arTemp = CANAR;     //先CANAR现场保存，避免主循环里写完 CANAR 后产生中断，在中断里修改了 CANAR 内容
   97   1              store = AUXR2;      //后AUXR2现场保存
   98   1      
   99   1              AUXR2 |= 0x08;          //选择CAN2模块
  100   1              isr = CanReadReg(ISR);
  101   1      
  102   1              if((isr & 0x04) == 0x04)  //TI
  103   1              {
  104   2                      CANAR = ISR;
  105   2                      CANDR = 0x04;    //CLR FLAG
  106   2      
  107   2              B_Can2Send = 0;
  108   2        }
  109   1              if((isr & 0x08) == 0x08)  //RI
  110   1              {
  111   2                      CANAR = ISR;
  112   2                      CANDR = 0x08;    //CLR FLAG
  113   2      
  114   2                      B_Can2Read = 1;
  115   2              }
  116   1      
  117   1              if((isr & 0x40) == 0x40)  //ALI
  118   1              {
  119   2                      CANAR = ISR;
  120   2                      CANDR = 0x40;    //CLR FLAG
  121   2              }
  122   1      
C251 COMPILER V5.60.0,  AI8051U_CAN_Isr                                                    18/11/25  13:07:41  PAGE 3   

  123   1              if((isr & 0x20) == 0x20)  //EWI
  124   1              {
  125   2                      CANAR = MR;
  126   2                      CANDR &= ~0x04;  //清除 Reset Mode, 从BUS-OFF状态退出
  127   2      
  128   2                      CANAR = ISR;
  129   2                      CANDR = 0x20;    //CLR FLAG
  130   2              }
  131   1      
  132   1              if((isr & 0x10) == 0x10)  //EPI
  133   1              {
  134   2                      CANAR = ISR;
  135   2                      CANDR = 0x10;    //CLR FLAG
  136   2              }
  137   1      
  138   1              if((isr & 0x02) == 0x02)  //BEI
  139   1              {
  140   2                      CANAR = ISR;
  141   2                      CANDR = 0x02;    //CLR FLAG
  142   2              }
  143   1      
  144   1              if((isr & 0x01) == 0x01)  //DOI
  145   1              {
  146   2                      CANAR = ISR;
  147   2                      CANDR = 0x01;    //CLR FLAG
  148   2              }
  149   1      
  150   1              AUXR2 = store;     //先AUXR2现场恢复
  151   1              CANAR = arTemp;    //后CANAR现场恢复
  152   1      }
  153          
  154          


Module Information          Static   Overlayable
------------------------------------------------
  code size            =       614     ------
  ecode size           =    ------     ------
  data size            =    ------     ------
  idata size           =    ------     ------
  pdata size           =    ------     ------
  xdata size           =    ------     ------
  xdata-const size     =    ------     ------
  edata size           =    ------     ------
  bit size             =         4     ------
  ebit size            =    ------     ------
  bitaddressable size  =    ------     ------
  ebitaddressable size =    ------     ------
  far data size        =    ------     ------
  huge data size       =    ------     ------
  const size           =    ------     ------
  hconst size          =    ------     ------
End of Module Information.


C251 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
